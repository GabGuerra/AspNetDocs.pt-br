---
title: 'Tutorial: Implementar a funcionalidade CRUD - ASP.NET MVC com EF Core'
description: Neste tutorial, você examinará e personalizará o código CRUD (criar, ler, atualizar e excluir) que o scaffolding do MVC cria automaticamente para você em controladores e exibições.
author: rick-anderson
ms.author: tdykstra
ms.custom: mvc
ms.date: 02/04/2019
ms.topic: tutorial
uid: data/ef-mvc/crud
ms.openlocfilehash: 368b1774ba977ec8020a02d48705200fd54c3bbd
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/01/2019
ms.locfileid: "57052423"
---
# <a name="tutorial-implement-crud-functionality---aspnet-mvc-with-ef-core"></a><span data-ttu-id="c2bcc-103">Tutorial: Implementar a funcionalidade CRUD - ASP.NET MVC com EF Core</span><span class="sxs-lookup"><span data-stu-id="c2bcc-103">Tutorial: Implement CRUD Functionality - ASP.NET MVC with EF Core</span></span>

<span data-ttu-id="c2bcc-104">No tutorial anterior, você criou um aplicativo MVC que armazena e exibe dados usando o Entity Framework e o LocalDB do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-104">In the previous tutorial, you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="c2bcc-105">Neste tutorial, você examinará e personalizará o código CRUD (criar, ler, atualizar e excluir) que o scaffolding do MVC cria automaticamente para você em controladores e exibições.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-105">In this tutorial, you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE]
> <span data-ttu-id="c2bcc-106">É uma prática comum implementar o padrão de repositório para criar uma camada de abstração entre o controlador e a camada de acesso a dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-106">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="c2bcc-107">Para manter esses tutoriais simples e com foco no ensino de como usar o Entity Framework em si, eles não usam repositórios.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-107">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="c2bcc-108">Para obter informações sobre repositórios com o EF, consulte [o último tutorial desta série](advanced.md).</span><span class="sxs-lookup"><span data-stu-id="c2bcc-108">For information about repositories with EF, see [the last tutorial in this series](advanced.md).</span></span>

<span data-ttu-id="c2bcc-109">Neste tutorial, você:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-109">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="c2bcc-110">Personalizar a página Detalhes</span><span class="sxs-lookup"><span data-stu-id="c2bcc-110">Customize the Details page</span></span>
> * <span data-ttu-id="c2bcc-111">Atualizar a página Criar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-111">Update the Create page</span></span>
> * <span data-ttu-id="c2bcc-112">Atualizar a página Editar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-112">Update the Edit page</span></span>
> * <span data-ttu-id="c2bcc-113">Atualizar a página Excluir</span><span class="sxs-lookup"><span data-stu-id="c2bcc-113">Update the Delete page</span></span>
> * <span data-ttu-id="c2bcc-114">Fechará conexões de banco de dados</span><span class="sxs-lookup"><span data-stu-id="c2bcc-114">Close database connections</span></span>

## <a name="prerequisites"></a><span data-ttu-id="c2bcc-115">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="c2bcc-115">Prerequisites</span></span>

* [<span data-ttu-id="c2bcc-116">Introdução ao EF Core em um aplicativo Web ASP.NET Core MVC</span><span class="sxs-lookup"><span data-stu-id="c2bcc-116">Get started with EF Core in an ASP.NET Core MVC web app</span></span>](intro.md)

## <a name="customize-the-details-page"></a><span data-ttu-id="c2bcc-117">Personalizar a página Detalhes</span><span class="sxs-lookup"><span data-stu-id="c2bcc-117">Customize the Details page</span></span>

<span data-ttu-id="c2bcc-118">O código gerado por scaffolding da página Índice de Alunos omitiu a propriedade `Enrollments`, porque essa propriedade contém uma coleção.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-118">The scaffolded code for the Students Index page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="c2bcc-119">Na página **Detalhes**, você exibirá o conteúdo da coleção em uma tabela HTML.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-119">In the **Details** page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="c2bcc-120">Em *Controllers/StudentsController.cs*, o método de ação para a exibição Detalhes usa o método `SingleOrDefaultAsync` para recuperar uma única entidade `Student`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-120">In *Controllers/StudentsController.cs*, the action method for the Details view uses the `SingleOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="c2bcc-121">Adicione um código que chama `Include`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-121">Add code that calls `Include`.</span></span> <span data-ttu-id="c2bcc-122">Os métodos `ThenInclude` e `AsNoTracking`, conforme mostrado no código realçado a seguir.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-122">`ThenInclude`,  and `AsNoTracking` methods, as shown in the following highlighted code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]

<span data-ttu-id="c2bcc-123">Os métodos `Include` e `ThenInclude` fazem com que o contexto carregue a propriedade de navegação `Student.Enrollments` e, dentro de cada registro, a propriedade de navegação `Enrollment.Course`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-123">The `Include` and `ThenInclude` methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span>  <span data-ttu-id="c2bcc-124">Você aprenderá mais sobre esses métodos no tutorial [Ler dados relacionados](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="c2bcc-124">You'll learn more about these methods in the [read related data](read-related-data.md) tutorial.</span></span>

<span data-ttu-id="c2bcc-125">O método `AsNoTracking` melhora o desempenho em cenários em que as entidades retornadas não serão atualizadas no tempo de vida do contexto atual.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-125">The `AsNoTracking` method improves performance in scenarios where the entities returned won't be updated in the current context's lifetime.</span></span> <span data-ttu-id="c2bcc-126">Você aprenderá mais sobre `AsNoTracking` ao final deste tutorial.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-126">You'll learn more about `AsNoTracking` at the end of this tutorial.</span></span>

### <a name="route-data"></a><span data-ttu-id="c2bcc-127">Dados de rota</span><span class="sxs-lookup"><span data-stu-id="c2bcc-127">Route data</span></span>

<span data-ttu-id="c2bcc-128">O valor de chave que é passado para o método `Details` é obtido dos *dados de rota*.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-128">The key value that's passed to the `Details` method comes from *route data*.</span></span> <span data-ttu-id="c2bcc-129">Dados de rota são dados que o associador de modelos encontrou em um segmento da URL.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-129">Route data is data that the model binder found in a segment of the URL.</span></span> <span data-ttu-id="c2bcc-130">Por exemplo, a rota padrão especifica os segmentos de controlador, ação e ID:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-130">For example, the default route specifies controller, action, and id segments:</span></span>

[!code-csharp[](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]

<span data-ttu-id="c2bcc-131">Na URL a seguir, a rota padrão mapeia Instructor como o controlador, Index como a ação e 1 como a ID; esses são valores de dados de rota.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-131">In the following URL, the default route maps Instructor as the controller, Index as the action, and 1 as the id; these are route data values.</span></span>

```
http://localhost:1230/Instructor/Index/1?courseID=2021
```

<span data-ttu-id="c2bcc-132">A última parte da URL ("?courseID=2021") é um valor de cadeia de caracteres de consulta.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-132">The last part of the URL ("?courseID=2021") is a query string value.</span></span> <span data-ttu-id="c2bcc-133">O associador de modelos passará o valor da ID para o parâmetro `id` do método `Details` se você passá-lo como um valor de cadeia de caracteres de consulta:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-133">The model binder will also pass the ID value to the `Details` method `id` parameter if you pass it as a query string value:</span></span>

```
http://localhost:1230/Instructor/Index?id=1&CourseID=2021
```

<span data-ttu-id="c2bcc-134">Na página Índice, as URLs de hiperlinks são criadas por instruções de auxiliar de marcação na exibição do Razor.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-134">In the Index page, hyperlink URLs are created by tag helper statements in the Razor view.</span></span> <span data-ttu-id="c2bcc-135">No código Razor a seguir, o parâmetro `id` corresponde à rota padrão e, portanto, `id` é adicionada aos dados de rota.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-135">In the following Razor code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

```html
<a asp-action="Edit" asp-route-id="@item.ID">Edit</a>
```

<span data-ttu-id="c2bcc-136">Isso gera o seguinte HTML quando `item.ID` é 6:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-136">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit/6">Edit</a>
```

<span data-ttu-id="c2bcc-137">No código a seguir Razor, `studentID` não corresponde a um parâmetro na rota padrão e, portanto, ela é adicionada como uma cadeia de caracteres de consulta.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-137">In the following Razor code, `studentID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

```html
<a asp-action="Edit" asp-route-studentID="@item.ID">Edit</a>
```

<span data-ttu-id="c2bcc-138">Isso gera o seguinte HTML quando `item.ID` é 6:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-138">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit?studentID=6">Edit</a>
```

<span data-ttu-id="c2bcc-139">Para obter mais informações sobre os auxiliares de marca, confira <xref:mvc/views/tag-helpers/intro>.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-139">For more information about tag helpers, see <xref:mvc/views/tag-helpers/intro>.</span></span>

### <a name="add-enrollments-to-the-details-view"></a><span data-ttu-id="c2bcc-140">Adicionar registros à exibição Detalhes</span><span class="sxs-lookup"><span data-stu-id="c2bcc-140">Add enrollments to the Details view</span></span>

<span data-ttu-id="c2bcc-141">Abra *Views/Students/Details.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-141">Open *Views/Students/Details.cshtml*.</span></span> <span data-ttu-id="c2bcc-142">Cada campo é exibido usando auxiliares `DisplayNameFor` e `DisplayFor`, conforme mostrado no seguinte exemplo:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-142">Each field is displayed using `DisplayNameFor` and `DisplayFor` helpers, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=13-18&highlight=2,5)]

<span data-ttu-id="c2bcc-143">Após o último campo e imediatamente antes da marcação `</dl>` de fechamento, adicione o seguinte código para exibir uma lista de registros:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-143">After the last field and immediately before the closing `</dl>` tag, add the following code to display a list of enrollments:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=31-52)]

<span data-ttu-id="c2bcc-144">Se o recuo do código estiver incorreto depois de colar o código, pressione CTRL-K-D para corrigi-lo.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-144">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="c2bcc-145">Esse código percorre as entidades na propriedade de navegação `Enrollments`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-145">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="c2bcc-146">Para cada registro, ele exibe o nome do curso e a nota.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-146">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="c2bcc-147">O título do curso é recuperado da entidade Course, que é armazenada na propriedade de navegação `Course` da entidade Enrollments.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-147">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="c2bcc-148">Execute o aplicativo, selecione a guia **Alunos** e clique no link **Detalhes** de um aluno.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-148">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="c2bcc-149">Você verá a lista de cursos e notas do aluno selecionado:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-149">You see the list of courses and grades for the selected student:</span></span>

![Página Detalhes do Aluno](crud/_static/student-details.png)

## <a name="update-the-create-page"></a><span data-ttu-id="c2bcc-151">Atualizar a página Criar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-151">Update the Create page</span></span>

<span data-ttu-id="c2bcc-152">Em *StudentsController.cs*, modifique o método HttpPost `Create` adicionando um bloco try-catch e removendo a ID do atributo `Bind`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-152">In *StudentsController.cs*, modify the HttpPost `Create` method by adding a try-catch block and removing ID from the `Bind` attribute.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]

<span data-ttu-id="c2bcc-153">Esse código adiciona a entidade Student criada pelo associador de modelos do ASP.NET Core MVC ao conjunto de entidades Student e, em seguida, salva as alterações no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-153">This code adds the Student entity created by the ASP.NET Core MVC model binder to the Students entity set and then saves the changes to the database.</span></span> <span data-ttu-id="c2bcc-154">(Associador de modelos refere-se à funcionalidade do ASP.NET Core MVC que facilita o trabalho com os dados enviados por um formulário. Um associador de modelos converte os valores de formulário postados em tipos CLR e passa-os para o método de ação em parâmetros.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-154">(Model binder refers to the ASP.NET Core MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="c2bcc-155">Nesse caso, o associador de modelos cria uma instância de uma entidade Student usando valores de propriedade da coleção Form.)</span><span class="sxs-lookup"><span data-stu-id="c2bcc-155">In this case, the model binder instantiates a Student entity for you using property values from the Form collection.)</span></span>

<span data-ttu-id="c2bcc-156">Você removeu `ID` do atributo `Bind` porque a ID é o valor de chave primária que o SQL Server definirá automaticamente quando a linha for inserida.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-156">You removed `ID` from the `Bind` attribute because ID is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="c2bcc-157">A entrada do usuário não define o valor da ID.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-157">Input from the user doesn't set the ID value.</span></span>

<span data-ttu-id="c2bcc-158">Além do atributo `Bind`, o bloco try-catch é a única alteração que você fez no código gerado por scaffolding.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-158">Other than the `Bind` attribute, the try-catch block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="c2bcc-159">Se uma exceção que é derivada de `DbUpdateException` é capturada enquanto as alterações estão sendo salvas, uma mensagem de erro genérica é exibida.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-159">If an exception that derives from `DbUpdateException` is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="c2bcc-160">Às vezes, as exceções `DbUpdateException` são causadas por algo externo ao aplicativo, em vez de por um erro de programação e, portanto, o usuário é aconselhado a tentar novamente.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-160">`DbUpdateException` exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="c2bcc-161">Embora não implementado nesta amostra, um aplicativo de qualidade de produção registrará a exceção em log.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-161">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="c2bcc-162">Para obter mais informações, consulte a seção **Log para informações** em [Monitoramento e telemetria (criando aplicativos de nuvem do mundo real com o Azure)](/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span><span class="sxs-lookup"><span data-stu-id="c2bcc-162">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span></span>

<span data-ttu-id="c2bcc-163">O atributo `ValidateAntiForgeryToken` ajuda a impedir ataques CSRF (solicitação intersite forjada).</span><span class="sxs-lookup"><span data-stu-id="c2bcc-163">The `ValidateAntiForgeryToken` attribute helps prevent cross-site request forgery (CSRF) attacks.</span></span> <span data-ttu-id="c2bcc-164">O token é injetado automaticamente na exibição pelo [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) e é incluído quando o formulário é enviado pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-164">The token is automatically injected into the view by the [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) and is included when the form is submitted by the user.</span></span> <span data-ttu-id="c2bcc-165">O token é validado pelo atributo `ValidateAntiForgeryToken`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-165">The token is validated by the `ValidateAntiForgeryToken` attribute.</span></span> <span data-ttu-id="c2bcc-166">Para obter mais informações sobre o CSRF, consulte [Falsificação antissolicitação](../../security/anti-request-forgery.md).</span><span class="sxs-lookup"><span data-stu-id="c2bcc-166">For more information about CSRF, see [Anti-Request Forgery](../../security/anti-request-forgery.md).</span></span>

<a id="overpost"></a>
### <a name="security-note-about-overposting"></a><span data-ttu-id="c2bcc-167">Observação de segurança sobre o excesso de postagem</span><span class="sxs-lookup"><span data-stu-id="c2bcc-167">Security note about overposting</span></span>

<span data-ttu-id="c2bcc-168">O atributo `Bind` que o código gerado por scaffolding inclui no método `Create` é uma maneira de proteger contra o excesso de postagem em cenários de criação.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-168">The `Bind` attribute that the scaffolded code includes on the `Create` method is one way to protect against overposting in create scenarios.</span></span> <span data-ttu-id="c2bcc-169">Por exemplo, suponha que a entidade Student inclua uma propriedade `Secret` que você não deseja que essa página da Web defina.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-169">For example, suppose the Student entity includes a `Secret` property that you don't want this web page to set.</span></span>

```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstMidName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Secret { get; set; }
}
```

<span data-ttu-id="c2bcc-170">Mesmo se você não tiver um campo `Secret` na página da Web, um invasor poderá usar uma ferramenta como o Fiddler ou escrever um JavaScript para postar um valor de formulário `Secret`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-170">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="c2bcc-171">Sem o atributo `Bind` limitando os campos que o associador de modelos usa quando ele cria uma instância de Student, o associador de modelos seleciona esse valor de formulário `Secret` e usa-o para criar a instância da entidade Student.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-171">Without the `Bind` attribute limiting the fields that the model binder uses when it creates a Student instance, the model binder would pick up that `Secret` form value and use it to create the Student entity instance.</span></span> <span data-ttu-id="c2bcc-172">Em seguida, seja qual for o valor que o invasor especificou para o campo de formulário `Secret`, ele é atualizado no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-172">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="c2bcc-173">A imagem a seguir mostra a ferramenta Fiddler adicionando o campo `Secret` (com o valor "OverPost") aos valores de formulário postados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-173">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Fiddler adicionando o campo Secreto](crud/_static/fiddler.png)

<span data-ttu-id="c2bcc-175">Em seguida, o valor "OverPost" é adicionado com êxito à propriedade `Secret` da linha inserida, embora você nunca desejou que a página da Web pudesse definir essa propriedade.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-175">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

<span data-ttu-id="c2bcc-176">Impeça o excesso de postagem em cenários de edição lendo a entidade do banco de dados primeiro e, em seguida, chamando `TryUpdateModel`, passando uma lista explícita de propriedades permitidas.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-176">You can prevent overposting in edit scenarios by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="c2bcc-177">Esse é o método usado nestes tutoriais.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-177">That's the method used in these tutorials.</span></span>

<span data-ttu-id="c2bcc-178">Uma maneira alternativa de impedir o excesso de postagem preferida por muitos desenvolvedores é usar modelos de exibição em vez de classes de entidade com o model binding.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-178">An alternative way to prevent overposting that's preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="c2bcc-179">Inclua apenas as propriedades que você deseja atualizar no modelo de exibição.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-179">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="c2bcc-180">Quando o associador de modelos MVC tiver concluído, copie as propriedades do modelo de exibição para a instância da entidade, opcionalmente usando uma ferramenta como o AutoMapper.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-180">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as AutoMapper.</span></span> <span data-ttu-id="c2bcc-181">Use `_context.Entry` na instância de entidade para definir seu estado como `Unchanged` e, em seguida, defina `Property("PropertyName").IsModified` como verdadeiro em cada propriedade da entidade incluída no modelo de exibição.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-181">Use `_context.Entry` on the entity instance to set its state to `Unchanged`, and then set `Property("PropertyName").IsModified` to true on each entity property that's included in the view model.</span></span> <span data-ttu-id="c2bcc-182">Esse método funciona nos cenários de edição e criação.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-182">This method works in both edit and create scenarios.</span></span>

### <a name="test-the-create-page"></a><span data-ttu-id="c2bcc-183">Testar a página Criar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-183">Test the Create page</span></span>

<span data-ttu-id="c2bcc-184">O código em *Views/Students/Create.cshtml* usa os auxiliares de marcação `label`, `input` e `span` (para mensagens de validação) para cada campo.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-184">The code in *Views/Students/Create.cshtml* uses `label`, `input`, and `span` (for validation messages) tag helpers for each field.</span></span>

<span data-ttu-id="c2bcc-185">Execute o aplicativo, selecione a guia **Alunos** e, em seguida, clique em **Criar Novo**.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-185">Run the app, select the **Students** tab, and click **Create New**.</span></span>

<span data-ttu-id="c2bcc-186">Insira nomes e uma data.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-186">Enter names and a date.</span></span> <span data-ttu-id="c2bcc-187">Tente inserir uma data inválida se o navegador permitir fazer isso.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-187">Try entering an invalid date if your browser lets you do that.</span></span> <span data-ttu-id="c2bcc-188">(Alguns navegadores forçam o uso de um seletor de data.) Em seguida, clique em **Criar** para ver a mensagem de erro.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-188">(Some browsers force you to use a date picker.) Then click **Create** to see the error message.</span></span>

![Erro de validação de data](crud/_static/date-error.png)

<span data-ttu-id="c2bcc-190">Essa é a validação do lado do servidor que você obtém por padrão; em um tutorial posterior, você verá como adicionar atributos que gerarão o código para a validação do lado do cliente também.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-190">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="c2bcc-191">O código realçado a seguir mostra a verificação de validação de modelo no método `Create`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-191">The following highlighted code shows the model validation check in the `Create` method.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]

<span data-ttu-id="c2bcc-192">Altere a data para um valor válido e clique em **Criar** para ver o novo aluno ser exibido na página **Índice**.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-192">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="c2bcc-193">Atualizar a página Editar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-193">Update the Edit page</span></span>

<span data-ttu-id="c2bcc-194">Em *StudentController.cs*, o método HttpGet `Edit` (aquele sem o atributo `HttpPost`) usa o método `SingleOrDefaultAsync` para recuperar a entidade Student selecionada, como você viu no método `Details`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-194">In *StudentController.cs*, the HttpGet `Edit` method (the one without the `HttpPost` attribute) uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="c2bcc-195">Não é necessário alterar esse método.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-195">You don't need to change this method.</span></span>

### <a name="recommended-httppost-edit-code-read-and-update"></a><span data-ttu-id="c2bcc-196">Código HttpPost Edit recomendado: Ler e atualizar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-196">Recommended HttpPost Edit code: Read and update</span></span>

<span data-ttu-id="c2bcc-197">Substitua o método de ação HttpPost Edit pelo código a seguir.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-197">Replace the HttpPost Edit action method with the following code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]

<span data-ttu-id="c2bcc-198">Essas alterações implementam uma melhor prática de segurança para evitar o excesso de postagem.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-198">These changes implement a security best practice to prevent overposting.</span></span> <span data-ttu-id="c2bcc-199">O scaffolder gerou um atributo `Bind` e adicionou a entidade criada pelo associador de modelos ao conjunto de entidades com um sinalizador `Modified`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-199">The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a `Modified` flag.</span></span> <span data-ttu-id="c2bcc-200">Esse código não é recomendado para muitos cenários porque o atributo `Bind` limpa os dados pré-existentes nos campos não listados no parâmetro `Include`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-200">That code isn't recommended for many scenarios because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span>

<span data-ttu-id="c2bcc-201">O novo código lê a entidade existente e chama `TryUpdateModel` para atualizar os campos na entidade recuperada [com base na entrada do usuário nos dados de formulário postados](xref:mvc/models/model-binding#how-model-binding-works).</span><span class="sxs-lookup"><span data-stu-id="c2bcc-201">The new code reads the existing entity and calls `TryUpdateModel` to update fields in the retrieved entity [based on user input in the posted form data](xref:mvc/models/model-binding#how-model-binding-works).</span></span> <span data-ttu-id="c2bcc-202">O controle automático de alterações do Entity Framework define o sinalizador `Modified` nos campos alterados pela entrada de formulário.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-202">The Entity Framework's automatic change tracking sets the `Modified` flag on the fields that are changed by form input.</span></span> <span data-ttu-id="c2bcc-203">Quando o método `SaveChanges` é chamado, o Entity Framework cria instruções SQL para atualizar a linha de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-203">When the `SaveChanges` method is called, the Entity Framework creates SQL statements to update the database row.</span></span> <span data-ttu-id="c2bcc-204">Os conflitos de simultaneidade são ignorados e somente as colunas de tabela que foram atualizadas pelo usuário são atualizadas no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-204">Concurrency conflicts are ignored, and only the table columns that were updated by the user are updated in the database.</span></span> <span data-ttu-id="c2bcc-205">(Um tutorial posterior mostra como lidar com conflitos de simultaneidade.)</span><span class="sxs-lookup"><span data-stu-id="c2bcc-205">(A later tutorial shows how to handle concurrency conflicts.)</span></span>

<span data-ttu-id="c2bcc-206">Como uma melhor prática para evitar o excesso de postagem, os campos que você deseja que sejam atualizáveis pela página **Editar** estão na lista de permissões nos parâmetros `TryUpdateModel`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-206">As a best practice to prevent overposting, the fields that you want to be updateable by the **Edit** page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="c2bcc-207">(A cadeia de caracteres vazia antes da lista de campos na lista de parâmetros destina-se ao uso de um prefixo com os nomes de campos de formulário.) Atualmente, não há nenhum campo extra que está sendo protegido, mas listar os campos que você deseja que o associador de modelos associe garante que, se você adicionar campos ao modelo de dados no futuro, eles serão automaticamente protegidos até que você adicione-os aqui de forma explícita.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-207">(The empty string preceding the list of fields in the parameter list is for a prefix to use with the form fields names.) Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="c2bcc-208">Como resultado dessas alterações, a assinatura do método HttpPost `Edit` é a mesma do método HttpGet `Edit`; portanto, você já renomeou o método `EditPost`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-208">As a result of these changes, the method signature of the HttpPost `Edit` method is the same as the HttpGet `Edit` method; therefore you've renamed the method `EditPost`.</span></span>

### <a name="alternative-httppost-edit-code-create-and-attach"></a><span data-ttu-id="c2bcc-209">Código HttpPost Edit alternativo: Criar e anexar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-209">Alternative HttpPost Edit code: Create and attach</span></span>

<span data-ttu-id="c2bcc-210">O código de edição HttpPost recomendado garante que apenas as colunas alteradas sejam atualizadas e preserva os dados nas propriedades que você não deseja incluir para o model binding.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-210">The recommended HttpPost edit code ensures that only changed columns get updated and preserves data in properties that you don't want included for model binding.</span></span> <span data-ttu-id="c2bcc-211">No entanto, a abordagem de primeira leitura exige uma leitura de banco de dados extra e pode resultar em um código mais complexo para lidar com conflitos de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-211">However, the read-first approach requires an extra database read, and can result in more complex code for handling concurrency conflicts.</span></span> <span data-ttu-id="c2bcc-212">Uma alternativa é anexar uma entidade criada pelo associador de modelos ao contexto do EF e marcá-la como modificada.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-212">An alternative is to attach an entity created by the model binder to the EF context and mark it as modified.</span></span> <span data-ttu-id="c2bcc-213">(Não atualize o projeto com esse código; ele é mostrado somente para ilustrar uma abordagem opcional.)</span><span class="sxs-lookup"><span data-stu-id="c2bcc-213">(Don't update your project with this code, it's only shown to illustrate an optional approach.)</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]

<span data-ttu-id="c2bcc-214">Use essa abordagem quando a interface do usuário da página da Web incluir todos os campos na entidade e puder atualizar qualquer um deles.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-214">You can use this approach when the web page UI includes all of the fields in the entity and can update any of them.</span></span>

<span data-ttu-id="c2bcc-215">O código gerado por scaffolding usa a abordagem "criar e anexar", mas apenas captura exceções `DbUpdateConcurrencyException` e retorna códigos de erro 404.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-215">The scaffolded code uses the create-and-attach approach but only catches `DbUpdateConcurrencyException` exceptions and returns 404 error codes.</span></span>  <span data-ttu-id="c2bcc-216">O exemplo mostrado captura qualquer exceção de atualização de banco de dados e exibe uma mensagem de erro.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-216">The example shown catches any database update exception and displays an error message.</span></span>

### <a name="entity-states"></a><span data-ttu-id="c2bcc-217">Estados da entidade</span><span class="sxs-lookup"><span data-stu-id="c2bcc-217">Entity States</span></span>

<span data-ttu-id="c2bcc-218">O contexto de banco de dados controla se as entidades em memória estão em sincronia com suas linhas correspondentes no banco de dados, e essas informações determinam o que acontece quando você chama o método `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-218">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="c2bcc-219">Por exemplo, quando você passa uma nova entidade para o método `Add`, o estado dessa entidade é definido como `Added`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-219">For example, when you pass a new entity to the `Add` method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="c2bcc-220">Em seguida, quando você chama o método `SaveChanges`, o contexto de banco de dados emite um comando SQL INSERT.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-220">Then when you call the `SaveChanges` method, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="c2bcc-221">Uma entidade pode estar em um dos seguintes estados:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-221">An entity may be in one of the following states:</span></span>

* <span data-ttu-id="c2bcc-222">`Added`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-222">`Added`.</span></span> <span data-ttu-id="c2bcc-223">A entidade ainda não existe no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-223">The entity doesn't yet exist in the database.</span></span> <span data-ttu-id="c2bcc-224">O método `SaveChanges` emite uma instrução INSERT.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-224">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="c2bcc-225">`Unchanged`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-225">`Unchanged`.</span></span> <span data-ttu-id="c2bcc-226">Nada precisa ser feito com essa entidade pelo método `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-226">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="c2bcc-227">Ao ler uma entidade do banco de dados, a entidade começa com esse status.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-227">When you read an entity from the database, the entity starts out with this status.</span></span>

* <span data-ttu-id="c2bcc-228">`Modified`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-228">`Modified`.</span></span> <span data-ttu-id="c2bcc-229">Alguns ou todos os valores de propriedade da entidade foram modificados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-229">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="c2bcc-230">O método `SaveChanges` emite uma instrução UPDATE.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-230">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="c2bcc-231">`Deleted`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-231">`Deleted`.</span></span> <span data-ttu-id="c2bcc-232">A entidade foi marcada para exclusão.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-232">The entity has been marked for deletion.</span></span> <span data-ttu-id="c2bcc-233">O método `SaveChanges` emite uma instrução DELETE.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-233">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="c2bcc-234">`Detached`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-234">`Detached`.</span></span> <span data-ttu-id="c2bcc-235">A entidade não está sendo controlada pelo contexto de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-235">The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="c2bcc-236">Em um aplicativo da área de trabalho, em geral, as alterações de estado são definidas automaticamente.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-236">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="c2bcc-237">Você lê uma entidade e faz alterações em alguns de seus valores de propriedade.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-237">You read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="c2bcc-238">Isso faz com que seu estado da entidade seja alterado automaticamente para `Modified`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-238">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="c2bcc-239">Em seguida, quando você chama `SaveChanges`, o Entity Framework gera uma instrução SQL UPDATE que atualiza apenas as propriedades reais que você alterou.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-239">Then when you call `SaveChanges`, the Entity Framework generates a SQL UPDATE statement that updates only the actual properties that you changed.</span></span>

<span data-ttu-id="c2bcc-240">Em um aplicativo Web, o `DbContext` que inicialmente lê uma entidade e exibe seus dados a serem editados é descartado depois que uma página é renderizada.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-240">In a web app, the `DbContext` that initially reads an entity and displays its data to be edited is disposed after a page is rendered.</span></span> <span data-ttu-id="c2bcc-241">Quando o método de ação HttpPost `Edit` é chamado, é feita uma nova solicitação da Web e você tem uma nova instância do `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-241">When the HttpPost `Edit` action method is called,  a new web request is made and you have a new instance of the `DbContext`.</span></span> <span data-ttu-id="c2bcc-242">Se você ler novamente a entidade nesse novo contexto, simulará o processamento da área de trabalho.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-242">If you re-read the entity in that new context, you simulate desktop processing.</span></span>

<span data-ttu-id="c2bcc-243">Mas se você não desejar fazer a operação de leitura extra, precisará usar o objeto de entidade criado pelo associador de modelos.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-243">But if you don't want to do the extra read operation, you have to use the entity object created by the model binder.</span></span>  <span data-ttu-id="c2bcc-244">A maneira mais simples de fazer isso é definir o estado da entidade como Modificado, como é feito no código HttpPost Edit alternativo mostrado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-244">The simplest way to do this is to set the entity state to Modified as is done in the alternative HttpPost Edit code shown earlier.</span></span> <span data-ttu-id="c2bcc-245">Em seguida, quando você chama `SaveChanges`, o Entity Framework atualiza todas as colunas da linha de banco de dados, porque o contexto não tem como saber quais propriedades foram alteradas.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-245">Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>

<span data-ttu-id="c2bcc-246">Caso deseje evitar a abordagem de primeira leitura, mas também deseje que a instrução SQL UPDATE atualize somente os campos que o usuário realmente alterar, o código será mais complexo.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-246">If you want to avoid the read-first approach, but you also want the SQL UPDATE statement to update only the fields that the user actually changed, the code is more complex.</span></span> <span data-ttu-id="c2bcc-247">É necessário salvar os valores originais de alguma forma (por exemplo, usando campos ocultos) para que eles estejam disponíveis quando o método HttpPost `Edit` for chamado.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-247">You have to save the original values in some way (such as by using hidden fields) so that they're available when the HttpPost `Edit` method is called.</span></span> <span data-ttu-id="c2bcc-248">Em seguida, você pode criar uma entidade Student usando os valores originais, chamar o método `Attach` com a versão original da entidade, atualizar os valores da entidade para os novos valores e, em seguida, chamar `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-248">Then you can create a Student entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges`.</span></span>

### <a name="test-the-edit-page"></a><span data-ttu-id="c2bcc-249">Testar a página Editar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-249">Test the Edit page</span></span>

<span data-ttu-id="c2bcc-250">Execute o aplicativo, selecione a guia **Alunos** e, em seguida, clique em um hiperlink **Editar**.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-250">Run the app, select the **Students** tab, then click an **Edit** hyperlink.</span></span>

![Página Editar Alunos](crud/_static/student-edit.png)

<span data-ttu-id="c2bcc-252">Altere alguns dos dados e clique em **Salvar**.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-252">Change some of the data and click **Save**.</span></span> <span data-ttu-id="c2bcc-253">A página **Índice** será aberta e você verá os dados alterados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-253">The **Index** page opens and you see the changed data.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="c2bcc-254">Atualizar a página Excluir</span><span class="sxs-lookup"><span data-stu-id="c2bcc-254">Update the Delete page</span></span>

<span data-ttu-id="c2bcc-255">Em *StudentController.cs*, o código de modelo para o método HttpGet `Delete` usa o método `SingleOrDefaultAsync` para recuperar a entidade Student selecionada, como você viu nos métodos Details e Edit.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-255">In *StudentController.cs*, the template code for the HttpGet `Delete` method uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the Details and Edit methods.</span></span> <span data-ttu-id="c2bcc-256">No entanto, para implementar uma mensagem de erro personalizada quando a chamada a `SaveChanges` falhar, você adicionará uma funcionalidade a esse método e à sua exibição correspondente.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-256">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="c2bcc-257">Como você viu para operações de atualização e criação, as operações de exclusão exigem dois métodos de ação.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-257">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="c2bcc-258">O método chamado em resposta a uma solicitação GET mostra uma exibição que dá ao usuário uma oportunidade de aprovar ou cancelar a operação de exclusão.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-258">The method that's called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="c2bcc-259">Se o usuário aprová-la, uma solicitação POST será criada.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-259">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="c2bcc-260">Quando isso acontece, o método HttpPost `Delete` é chamado e, em seguida, esse método executa, de fato, a operação de exclusão.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-260">When that happens, the HttpPost `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="c2bcc-261">Você adicionará um bloco try-catch ao método HttpPost `Delete` para tratar os erros que podem ocorrer quando o banco de dados é atualizado.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-261">You'll add a try-catch block to the HttpPost `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="c2bcc-262">Se ocorrer um erro, o método HttpPost Delete chamará o método HttpGet Delete, passando a ele um parâmetro que indica que ocorreu um erro.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-262">If an error occurs, the HttpPost Delete method calls the HttpGet Delete method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="c2bcc-263">Em seguida, o método HttpGet Delete exibe novamente a página de confirmação, junto com a mensagem de erro, dando ao usuário a oportunidade de cancelar ou tentar novamente.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-263">The HttpGet Delete method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

<span data-ttu-id="c2bcc-264">Substitua o método de ação HttpGet `Delete` pelo código a seguir, que gerencia o relatório de erros.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-264">Replace the HttpGet `Delete` action method with the following code, which manages error reporting.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]

<span data-ttu-id="c2bcc-265">Este código aceita um parâmetro opcional que indica se o método foi chamado após uma falha ao salvar as alterações.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-265">This code accepts an optional parameter that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="c2bcc-266">Esse parâmetro é falso quando o método HttpGet `Delete` é chamado sem uma falha anterior.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-266">This parameter is false when the HttpGet `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="c2bcc-267">Quando ele é chamado pelo método HttpPost `Delete` em resposta a um erro de atualização de banco de dados, o parâmetro é verdadeiro, e uma mensagem de erro é passada para a exibição.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-267">When it's called by the HttpPost `Delete` method in response to a database update error, the parameter is true and an error message is passed to the view.</span></span>

### <a name="the-read-first-approach-to-httppost-delete"></a><span data-ttu-id="c2bcc-268">A abordagem de primeira leitura para HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="c2bcc-268">The read-first approach to HttpPost Delete</span></span>

<span data-ttu-id="c2bcc-269">Substitua o método de ação HttpPost `Delete` (chamado `DeleteConfirmed`) pelo código a seguir, que executa a operação de exclusão real e captura os erros de atualização de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-269">Replace the HttpPost `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6,8-11,13-14,18-23)]

<span data-ttu-id="c2bcc-270">Esse código recupera a entidade selecionada e, em seguida, chama o método `Remove` para definir o status da entidade como `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-270">This code retrieves the selected entity, then calls the `Remove` method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="c2bcc-271">Quando `SaveChanges` é chamado, um comando SQL DELETE é gerado.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-271">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span>

### <a name="the-create-and-attach-approach-to-httppost-delete"></a><span data-ttu-id="c2bcc-272">A abordagem "criar e anexar" para HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="c2bcc-272">The create-and-attach approach to HttpPost Delete</span></span>

<span data-ttu-id="c2bcc-273">Se a melhoria do desempenho de um aplicativo de alto volume for uma prioridade, você poderá evitar uma consulta SQL desnecessária criando uma instância de uma entidade Student usando somente o valor de chave primária e, em seguida, definindo o estado da entidade como `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-273">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query by instantiating a Student entity using only the primary key value and then setting the entity state to `Deleted`.</span></span> <span data-ttu-id="c2bcc-274">Isso é tudo o que o Entity Framework precisa para excluir a entidade.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-274">That's all that the Entity Framework needs in order to delete the entity.</span></span> <span data-ttu-id="c2bcc-275">(Não coloque esse código no projeto; ele está aqui apenas para ilustrar uma alternativa.)</span><span class="sxs-lookup"><span data-stu-id="c2bcc-275">(Don't put this code in your project; it's here just to illustrate an alternative.)</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]

<span data-ttu-id="c2bcc-276">Se a entidade tiver dados relacionados, eles também deverão ser excluídos. Verifique se a exclusão em cascata está configurada no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-276">If the entity has related data that should also be deleted, make sure that cascade delete is configured in the database.</span></span> <span data-ttu-id="c2bcc-277">Com essa abordagem para a exclusão de entidade, o EF talvez não perceba que há entidades relacionadas a serem excluídas.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-277">With this approach to entity deletion, EF might not realize there are related entities to be deleted.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="c2bcc-278">Atualizar a exibição Excluir</span><span class="sxs-lookup"><span data-stu-id="c2bcc-278">Update the Delete view</span></span>

<span data-ttu-id="c2bcc-279">Em *Views/Student/Delete.cshtml*, adicione uma mensagem de erro entre o cabeçalho h2 e o cabeçalho h3, conforme mostrado no seguinte exemplo:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-279">In *Views/Student/Delete.cshtml*, add an error message between the h2 heading and the h3 heading, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Delete.cshtml?range=7-9&highlight=2)]

<span data-ttu-id="c2bcc-280">Execute o aplicativo, selecione a guia **Alunos** e, em seguida, clique em um hiperlink **Excluir**:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-280">Run the app, select the **Students** tab, and click a **Delete** hyperlink:</span></span>

![Página Confirmação de exclusão](crud/_static/student-delete.png)

<span data-ttu-id="c2bcc-282">Clique em **Excluir**.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-282">Click **Delete**.</span></span> <span data-ttu-id="c2bcc-283">A página Índice será exibida sem o aluno excluído.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-283">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="c2bcc-284">(Você verá um exemplo de código de tratamento de erro em ação no tutorial sobre simultaneidade.)</span><span class="sxs-lookup"><span data-stu-id="c2bcc-284">(You'll see an example of the error handling code in action in the concurrency tutorial.)</span></span>

## <a name="close-database-connections"></a><span data-ttu-id="c2bcc-285">Fechará conexões de banco de dados</span><span class="sxs-lookup"><span data-stu-id="c2bcc-285">Close database connections</span></span>

<span data-ttu-id="c2bcc-286">Para liberar os recursos contidos em uma conexão de banco de dados, a instância de contexto precisa ser descartada assim que possível quando você tiver terminado.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-286">To free up the resources that a database connection holds, the context instance must be disposed as soon as possible when you are done with it.</span></span> <span data-ttu-id="c2bcc-287">A [injeção de dependência](../../fundamentals/dependency-injection.md) interna do ASP.NET Core cuida dessa tarefa para você.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-287">The ASP.NET Core built-in [dependency injection](../../fundamentals/dependency-injection.md) takes care of that task for you.</span></span>

<span data-ttu-id="c2bcc-288">Em *Startup.cs*, chame o [método de extensão AddDbContext](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) para provisionar a classe `DbContext` no contêiner de DI do ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-288">In *Startup.cs*, you call the [AddDbContext extension method](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) to provision the `DbContext` class in the ASP.NET Core DI container.</span></span> <span data-ttu-id="c2bcc-289">Esse método define o tempo de vida do serviço como `Scoped` por padrão.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-289">That method sets the service lifetime to `Scoped` by default.</span></span> <span data-ttu-id="c2bcc-290">`Scoped` significa que o tempo de vida do objeto de contexto coincide com o tempo de vida da solicitação da Web, e o método `Dispose` será chamado automaticamente ao final da solicitação da Web.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-290">`Scoped` means the context object lifetime coincides with the web request life time, and the `Dispose` method will be called automatically at the end of the web request.</span></span>

## <a name="handle-transactions"></a><span data-ttu-id="c2bcc-291">Lidar com transações</span><span class="sxs-lookup"><span data-stu-id="c2bcc-291">Handle transactions</span></span>

<span data-ttu-id="c2bcc-292">Por padrão, o Entity Framework implementa transações de forma implícita.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-292">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="c2bcc-293">Em cenários em que são feitas alterações em várias linhas ou tabelas e, em seguida, `SaveChanges` é chamado, o Entity Framework verifica automaticamente se todas as alterações tiveram êxito ou se falharam.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-293">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or they all fail.</span></span> <span data-ttu-id="c2bcc-294">Se algumas alterações forem feitas pela primeira vez e, em seguida, ocorrer um erro, essas alterações serão revertidas automaticamente.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-294">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="c2bcc-295">Para cenários em que você precisa de mais controle – por exemplo, se desejar incluir operações feitas fora do Entity Framework em uma transação –, consulte [Transações](/ef/core/saving/transactions).</span><span class="sxs-lookup"><span data-stu-id="c2bcc-295">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Transactions](/ef/core/saving/transactions).</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="c2bcc-296">Consultas sem controle</span><span class="sxs-lookup"><span data-stu-id="c2bcc-296">No-tracking queries</span></span>

<span data-ttu-id="c2bcc-297">Quando um contexto de banco de dados recupera linhas de tabela e cria objetos de entidade que as representam, por padrão, ele controla se as entidades em memória estão em sincronia com o que está no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-297">When a database context retrieves table rows and creates entity objects that represent them, by default it keeps track of whether the entities in memory are in sync with what's in the database.</span></span> <span data-ttu-id="c2bcc-298">Os dados em memória atuam como um cache e são usados quando uma entidade é atualizada.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-298">The data in memory acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="c2bcc-299">Esse cache costuma ser desnecessário em um aplicativo Web porque as instâncias de contexto são normalmente de curta duração (uma nova é criada e descartada para cada solicitação) e o contexto que lê uma entidade normalmente é descartado antes que essa entidade seja usada novamente.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-299">This caching is often unnecessary in a web application because context instances are typically short-lived (a new one is created and disposed for each request) and the context that reads an entity is typically disposed before that entity is used again.</span></span>

<span data-ttu-id="c2bcc-300">Desabilite o controle de objetos de entidade em memória chamando o método `AsNoTracking`.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-300">You can disable tracking of entity objects in memory by calling the `AsNoTracking` method.</span></span> <span data-ttu-id="c2bcc-301">Os cenários típicos em que talvez você deseje fazer isso incluem os seguintes:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-301">Typical scenarios in which you might want to do that include the following:</span></span>

* <span data-ttu-id="c2bcc-302">Durante o tempo de vida do contexto, não é necessário atualizar entidades nem que o EF [carregue automaticamente as propriedades de navegação com entidades recuperadas por consultas separadas](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="c2bcc-302">During the context lifetime you don't need to update any entities, and you don't need EF to [automatically load navigation properties with  entities retrieved by separate queries](read-related-data.md).</span></span> <span data-ttu-id="c2bcc-303">Com frequência, essas condições são atendidas nos métodos de ação HttpGet de um controlador.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-303">Frequently these conditions are met in a controller's HttpGet action methods.</span></span>

* <span data-ttu-id="c2bcc-304">Você está executando uma consulta que recupera um volume grande de dados e apenas uma pequena parte dos dados retornados será atualizada.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-304">You are running a query that retrieves a large volume of data, and only a small portion of the returned data will be updated.</span></span> <span data-ttu-id="c2bcc-305">Pode ser mais eficiente desativar o controle para a consulta grande e executar uma consulta posteriormente para as poucas entidades que precisam ser atualizadas.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-305">It may be more efficient to turn off tracking for the large query, and run a query later for the few entities that need to be updated.</span></span>

* <span data-ttu-id="c2bcc-306">Você deseja anexar uma entidade para atualizá-la, mas anteriormente, recuperou a mesma entidade para uma finalidade diferente.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-306">You want to attach an entity in order to update it, but earlier you retrieved the same entity for a different purpose.</span></span> <span data-ttu-id="c2bcc-307">Como a entidade já está sendo controlada pelo contexto de banco de dados, não é possível anexar a entidade que você deseja alterar.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-307">Because the entity is already being tracked by the database context, you can't attach the entity that you want to change.</span></span> <span data-ttu-id="c2bcc-308">Uma maneira de lidar com essa situação é chamar `AsNoTracking` na consulta anterior.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-308">One way to handle this situation is to call `AsNoTracking` on the earlier query.</span></span>

<span data-ttu-id="c2bcc-309">Para obter mais informações, consulte [Controle vs. Sem controle](/ef/core/querying/tracking).</span><span class="sxs-lookup"><span data-stu-id="c2bcc-309">For more information, see [Tracking vs. No-Tracking](/ef/core/querying/tracking).</span></span>

## <a name="get-the-code"></a><span data-ttu-id="c2bcc-310">Obter o código</span><span class="sxs-lookup"><span data-stu-id="c2bcc-310">Get the code</span></span>

[<span data-ttu-id="c2bcc-311">Baixe ou exiba o aplicativo concluído.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-311">Download or view the completed application.</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/data/ef-mvc/intro/samples/cu-final)

## <a name="next-steps"></a><span data-ttu-id="c2bcc-312">Próximas etapas</span><span class="sxs-lookup"><span data-stu-id="c2bcc-312">Next steps</span></span>

<span data-ttu-id="c2bcc-313">Neste tutorial, você:</span><span class="sxs-lookup"><span data-stu-id="c2bcc-313">In this tutorial, you:</span></span>

> [!div class="checklist"]
> * <span data-ttu-id="c2bcc-314">Personalizou a página Detalhes</span><span class="sxs-lookup"><span data-stu-id="c2bcc-314">Customized the Details page</span></span>
> * <span data-ttu-id="c2bcc-315">Atualizou a página Criar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-315">Updated the Create page</span></span>
> * <span data-ttu-id="c2bcc-316">Atualizou a página Editar</span><span class="sxs-lookup"><span data-stu-id="c2bcc-316">Updated the Edit page</span></span>
> * <span data-ttu-id="c2bcc-317">Atualizou a página Excluir</span><span class="sxs-lookup"><span data-stu-id="c2bcc-317">Updated the Delete page</span></span>
> * <span data-ttu-id="c2bcc-318">Fechou conexões de banco de dados</span><span class="sxs-lookup"><span data-stu-id="c2bcc-318">Closed database connections</span></span>

<span data-ttu-id="c2bcc-319">Vá para o próximo artigo para saber como expandir a funcionalidade da página **Índice** adicionando classificação, filtragem e paginação.</span><span class="sxs-lookup"><span data-stu-id="c2bcc-319">Advance to the next article to learn how to expand the functionality of the **Index** page by adding sorting, filtering, and paging.</span></span>
> [!div class="nextstepaction"]
> [<span data-ttu-id="c2bcc-320">Classificação, filtragem e paginação</span><span class="sxs-lookup"><span data-stu-id="c2bcc-320">Sorting, filtering, and paging</span></span>](sort-filter-page.md)
