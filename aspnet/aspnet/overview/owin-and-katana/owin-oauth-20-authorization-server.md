---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Servidor de autorização do OAuth 2.0 de OWIN | Microsoft Docs
author: hongyes
description: Este tutorial orientará você sobre como implementar um servidor de autorização do OAuth 2.0 usando o middleware OWIN OAuth. Isso é que apenas configurações de um tutorial avançado...
ms.author: riande
ms.date: 01/28/2019
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: d5c8262d48c79616ca3069c37077ba99ffafb650
ms.sourcegitcommit: 289e051cc8a90e8f7127e239fda73047bde4de12
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/25/2019
ms.locfileid: "58426037"
---
# <a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="d72f8-104">Servidor de autorização OAuth 2.0 de OWIN</span><span class="sxs-lookup"><span data-stu-id="d72f8-104">OWIN OAuth 2.0 Authorization Server</span></span>

> <span data-ttu-id="d72f8-105">Este tutorial orientará você sobre como implementar um servidor de autorização do OAuth 2.0 usando o middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="d72f8-105">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="d72f8-106">Este é um tutorial avançado que descreve somente as etapas para criar um servidor de autorização do OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="d72f8-106">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="d72f8-107">Isso não é um tutorial passo a passo.</span><span class="sxs-lookup"><span data-stu-id="d72f8-107">This is not a step by step tutorial.</span></span> <span data-ttu-id="d72f8-108">[Baixe o código de exemplo](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="d72f8-108">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="d72f8-109">Essa estrutura de tópicos não deve ser se destina a ser usado para criar um aplicativo de produção seguro.</span><span class="sxs-lookup"><span data-stu-id="d72f8-109">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="d72f8-110">Este tutorial destina-se a fornecer somente uma estrutura de tópicos sobre como implementar um servidor de autorização do OAuth 2.0 usando o middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="d72f8-110">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="d72f8-111">Versões de software</span><span class="sxs-lookup"><span data-stu-id="d72f8-111">Software versions</span></span>
>
> | <span data-ttu-id="d72f8-112">**Mostrado no tutorial**</span><span class="sxs-lookup"><span data-stu-id="d72f8-112">**Shown in the tutorial**</span></span> | <span data-ttu-id="d72f8-113">**Também funciona com**</span><span class="sxs-lookup"><span data-stu-id="d72f8-113">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="d72f8-114">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="d72f8-114">Windows 8.1</span></span> | <span data-ttu-id="d72f8-115">Windows 10, Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="d72f8-115">Windows 10, Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="d72f8-116">Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="d72f8-116">Visual Studio 2017</span></span>](https://visualstudio.microsoft.com/downloads/)
> | <span data-ttu-id="d72f8-117">.NET 4.7.2</span><span class="sxs-lookup"><span data-stu-id="d72f8-117">.NET 4.7.2</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="d72f8-118">Perguntas e comentários</span><span class="sxs-lookup"><span data-stu-id="d72f8-118">Questions and comments</span></span>
>
> <span data-ttu-id="d72f8-119">Se você tiver perguntas que não estão diretamente relacionadas para o tutorial, você pode postá-los no [projeto Katana no GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="d72f8-119">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="d72f8-120">Para perguntas e comentários sobre o próprio tutorial, consulte a seção de comentários na parte inferior da página.</span><span class="sxs-lookup"><span data-stu-id="d72f8-120">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="d72f8-121">O [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) permite que um aplicativo de terceiros obter acesso limitado a um serviço HTTP.</span><span class="sxs-lookup"><span data-stu-id="d72f8-121">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="d72f8-122">Em vez de usar as credenciais do proprietário do recurso para acessar um recurso protegido, o cliente obtenha um token de acesso (que é uma cadeia de caracteres denotando um escopo específico, tempo de vida e outros atributos de acesso).</span><span class="sxs-lookup"><span data-stu-id="d72f8-122">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="d72f8-123">Tokens de acesso são emitidos para clientes de terceiros por um servidor de autorização com a aprovação do proprietário do recurso.</span><span class="sxs-lookup"><span data-stu-id="d72f8-123">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="d72f8-124">Este tutorial aborda:</span><span class="sxs-lookup"><span data-stu-id="d72f8-124">This tutorial will cover:</span></span>

- <span data-ttu-id="d72f8-125">Como criar um servidor de autorização para dar suporte à autorização de quatro tipos de concessão e tokens de atualização:</span><span class="sxs-lookup"><span data-stu-id="d72f8-125">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="d72f8-126">Concessão de código de autorização</span><span class="sxs-lookup"><span data-stu-id="d72f8-126">Authorization code grant</span></span>
    - <span data-ttu-id="d72f8-127">Concessão implícita</span><span class="sxs-lookup"><span data-stu-id="d72f8-127">Implicit Grant</span></span>
    - <span data-ttu-id="d72f8-128">Concessão de credenciais de senha do proprietário do recurso</span><span class="sxs-lookup"><span data-stu-id="d72f8-128">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="d72f8-129">Concessão de credenciais do cliente</span><span class="sxs-lookup"><span data-stu-id="d72f8-129">Client Credentials Grant</span></span>
- <span data-ttu-id="d72f8-130">Criando um servidor de recurso que é protegido por um token de acesso.</span><span class="sxs-lookup"><span data-stu-id="d72f8-130">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="d72f8-131">Criando clientes OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="d72f8-131">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="d72f8-132">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="d72f8-132">Prerequisites</span></span>

- <span data-ttu-id="d72f8-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) conforme indicado na **versões de Software** na parte superior da página.</span><span class="sxs-lookup"><span data-stu-id="d72f8-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="d72f8-134">Familiaridade com o OWIN.</span><span class="sxs-lookup"><span data-stu-id="d72f8-134">Familiarity with OWIN.</span></span> <span data-ttu-id="d72f8-135">Ver [Introdução ao projeto Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) e [o que há de novo no OWIN e Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="d72f8-135">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="d72f8-136">Familiaridade com [OAuth](http://tools.ietf.org/html/rfc6749) terminologia, incluindo [funções](http://tools.ietf.org/html/rfc6749#section-1.1), [fluxo do protocolo](http://tools.ietf.org/html/rfc6749#section-1.2), e [concessão de autorização](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="d72f8-136">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="d72f8-137">[Introdução do OAuth 2.0](http://tools.ietf.org/html/rfc6749#section-1) fornece uma boa introdução.</span><span class="sxs-lookup"><span data-stu-id="d72f8-137">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="d72f8-138">Criar um servidor de autorização</span><span class="sxs-lookup"><span data-stu-id="d72f8-138">Create an Authorization Server</span></span>

<span data-ttu-id="d72f8-139">Neste tutorial, estamos será aproximadamente esboço de como usar [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) e o ASP.NET MVC para criar um servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-139">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="d72f8-140">Esperamos fornecer assim que um download para o exemplo completo, como este tutorial não inclui cada etapa.</span><span class="sxs-lookup"><span data-stu-id="d72f8-140">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="d72f8-141">Primeiro, crie um aplicativo web vazio chamado *AuthorizationServer* e instalar os seguintes pacotes:</span><span class="sxs-lookup"><span data-stu-id="d72f8-141">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="d72f8-142">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="d72f8-142">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="d72f8-143">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="d72f8-143">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="d72f8-144">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="d72f8-144">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="d72f8-145">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="d72f8-145">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="d72f8-146">Owin (ou qualquer outro logon social de pacote como owin)</span><span class="sxs-lookup"><span data-stu-id="d72f8-146">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="d72f8-147">Adicionar um [classe de inicialização OWIN](owin-startup-class-detection.md) sob a pasta raiz do projeto chamada *inicialização*.</span><span class="sxs-lookup"><span data-stu-id="d72f8-147">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="d72f8-148">Criar uma *App\_iniciar* pasta.</span><span class="sxs-lookup"><span data-stu-id="d72f8-148">Create an *App\_Start* folder.</span></span> <span data-ttu-id="d72f8-149">Selecione o *App\_começar* pasta e use Shift + Alt + A para adicionar a versão baixada do *AuthorizationServer\App\_Start\Startup.Auth.cs* arquivo.</span><span class="sxs-lookup"><span data-stu-id="d72f8-149">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="d72f8-150">O código acima permite que os cookies e autenticação do Google, que são usados pelo próprio servidor de autorização para gerenciar contas de entrada externo/aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d72f8-150">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="d72f8-151">O `UseOAuthAuthorizationServer` método de extensão é configurar o servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-151">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="d72f8-152">As opções de configuração são:</span><span class="sxs-lookup"><span data-stu-id="d72f8-152">The setup options are:</span></span>

- <span data-ttu-id="d72f8-153">`AuthorizeEndpointPath`: O caminho da solicitação em que os aplicativos clientes redirecionam o agente do usuário para obter os usuários de consentimento para emitir um token ou código.</span><span class="sxs-lookup"><span data-stu-id="d72f8-153">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="d72f8-154">Ele deve começar com uma barra à esquerda, por exemplo, "`/Authorize`".</span><span class="sxs-lookup"><span data-stu-id="d72f8-154">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="d72f8-155">`TokenEndpointPath`: Os aplicativos de cliente do caminho de solicitação se comunicam diretamente para obter o token de acesso.</span><span class="sxs-lookup"><span data-stu-id="d72f8-155">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="d72f8-156">Ele deve começar com uma barra à esquerda, como "/ Token".</span><span class="sxs-lookup"><span data-stu-id="d72f8-156">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="d72f8-157">Se o cliente receberá um [client\_segredo](http://tools.ietf.org/html/rfc6749#appendix-A.2), ele deve ser fornecido para esse ponto de extremidade.</span><span class="sxs-lookup"><span data-stu-id="d72f8-157">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="d72f8-158">`ApplicationCanDisplayErrors`: Definido como `true` caso queira que o aplicativo web gerar uma página de erro personalizada para os erros de validação de cliente em `/Authorize` ponto de extremidade.</span><span class="sxs-lookup"><span data-stu-id="d72f8-158">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="d72f8-159">Isso é necessário apenas para casos em que o navegador não é redirecionado de volta para o aplicativo cliente, por exemplo, quando o `client_id` ou `redirect_uri` estão incorretas.</span><span class="sxs-lookup"><span data-stu-id="d72f8-159">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="d72f8-160">O `/Authorize` ponto de extremidade deve esperar ver "oauth. Erro","oauth. ErrorDescription"e"oauth. Propriedades de ErrorUri"são adicionadas ao ambiente OWIN.</span><span class="sxs-lookup"><span data-stu-id="d72f8-160">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="d72f8-161">Se não for true, o servidor de autorização retornará uma página de erro padrão com os detalhes do erro.</span><span class="sxs-lookup"><span data-stu-id="d72f8-161">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="d72f8-162">`AllowInsecureHttp`: True para permitir a autorizar e as solicitações de token para chegar em endereços de URI de HTTP e permitir a entrada `redirect_uri` autorizar os parâmetros de solicitação ter endereços de URI do HTTP.</span><span class="sxs-lookup"><span data-stu-id="d72f8-162">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="d72f8-163">Security - isso é apenas para desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="d72f8-163">Security - This is for development only.</span></span>
- <span data-ttu-id="d72f8-164">`Provider`: O objeto fornecido pelo aplicativo para processar eventos gerados pelo middleware de servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-164">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="d72f8-165">O aplicativo pode implementar a interface completamente ou pode criar uma instância de `OAuthAuthorizationServerProvider` e atribuir representantes necessários para os fluxos de OAuth que dá suporte a esse servidor.</span><span class="sxs-lookup"><span data-stu-id="d72f8-165">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="d72f8-166">`AuthorizationCodeProvider`: Produz um código de autorização de uso único para retornar ao aplicativo cliente.</span><span class="sxs-lookup"><span data-stu-id="d72f8-166">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="d72f8-167">Para o servidor OAuth ser seguro o aplicativo **devem** fornecer uma instância de `AuthorizationCodeProvider` em que o token produzido pelo `OnCreate/OnCreateAsync` evento é considerado válido para apenas uma chamada para `OnReceive/OnReceiveAsync`.</span><span class="sxs-lookup"><span data-stu-id="d72f8-167">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="d72f8-168">`RefreshTokenProvider`: Produz um token de atualização que pode ser usado para produzir um novo token de acesso quando necessário.</span><span class="sxs-lookup"><span data-stu-id="d72f8-168">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="d72f8-169">Se não fornecido o servidor de autorização não retornará tokens de atualização da `/Token` ponto de extremidade.</span><span class="sxs-lookup"><span data-stu-id="d72f8-169">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="d72f8-170">Gerenciamento de conta</span><span class="sxs-lookup"><span data-stu-id="d72f8-170">Account Management</span></span>

<span data-ttu-id="d72f8-171">OAuth não importa onde ou como você gerencia suas informações de conta de usuário.</span><span class="sxs-lookup"><span data-stu-id="d72f8-171">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="d72f8-172">Ele tem [ASP.NET Identity](../../../identity/index.md) que é responsável por ele.</span><span class="sxs-lookup"><span data-stu-id="d72f8-172">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="d72f8-173">Neste tutorial, estamos simplificará o código de gerenciamento de conta e apenas certifique-se de que o usuário pode fazer logon usando o cookie de middleware OWIN.</span><span class="sxs-lookup"><span data-stu-id="d72f8-173">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="d72f8-174">Aqui está o código de exemplo simplificado a `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="d72f8-174">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="d72f8-175">`ValidateClientRedirectUri` é usado para validar o cliente com a sua URL de redirecionamento registrado.</span><span class="sxs-lookup"><span data-stu-id="d72f8-175">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="d72f8-176">`ValidateClientAuthentication` verifica o cabeçalho de esquema básico e o corpo do formulário para obter as credenciais do cliente.</span><span class="sxs-lookup"><span data-stu-id="d72f8-176">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="d72f8-177">A página de logon é mostrada abaixo:</span><span class="sxs-lookup"><span data-stu-id="d72f8-177">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="d72f8-178">Examine OAuth 2 da IETF [concessão de código de autorização](http://tools.ietf.org/html/rfc6749#section-4.1) seção agora.</span><span class="sxs-lookup"><span data-stu-id="d72f8-178">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="d72f8-179">**Provedor** (na tabela a seguir) é [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Provedor, que é do tipo `OAuthAuthorizationServerProvider`, que contém todos os eventos de servidor OAuth.</span><span class="sxs-lookup"><span data-stu-id="d72f8-179">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="d72f8-180">Fluxo de etapas da seção de concessão de código de autorização</span><span class="sxs-lookup"><span data-stu-id="d72f8-180">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="d72f8-181">Download de exemplo executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d72f8-181">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d72f8-182">(A) o cliente inicia o fluxo, direcionando agente do proprietário do recurso do usuário para o ponto de extremidade de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-182">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="d72f8-183">O cliente inclui seu identificador de cliente, escopo solicitado, estado local e um URI de redirecionamento para o qual o servidor de autorização enviará o agente do usuário novamente quando o acesso é concedido (ou negado).</span><span class="sxs-lookup"><span data-stu-id="d72f8-183">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="d72f8-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="d72f8-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="d72f8-185">(B) o servidor de autorização autentica o proprietário do recurso (por meio do agente do usuário) e estabelece se o proprietário do recurso concede ou nega a solicitação de acesso do cliente.</span><span class="sxs-lookup"><span data-stu-id="d72f8-185">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="d72f8-186">**&lt;Se o usuário concede acesso&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d72f8-186">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d72f8-187">(C) supondo que o proprietário do recurso concede acesso, o servidor de autorização redireciona o agente do usuário para o cliente usando o URI de redirecionamento fornecido anteriormente (na solicitação ou durante o registro do cliente).</span><span class="sxs-lookup"><span data-stu-id="d72f8-187">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="d72f8-188">...</span><span class="sxs-lookup"><span data-stu-id="d72f8-188">...</span></span> |  |
|  |  |
| <span data-ttu-id="d72f8-189">(D) o cliente solicita um token de acesso do ponto de extremidade do servidor de autorização, incluindo o código de autorização recebido na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="d72f8-189">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="d72f8-190">Ao fazer a solicitação, o cliente autentica com o servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-190">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="d72f8-191">O cliente inclui o URI de redirecionamento usado para obter o código de autorização para verificação.</span><span class="sxs-lookup"><span data-stu-id="d72f8-191">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="d72f8-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d72f8-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="d72f8-193">Uma implementação de exemplo para `AuthorizationCodeProvider.CreateAsync` e `ReceiveAsync` controlar a criação e validação de código de autorização é mostrado abaixo.</span><span class="sxs-lookup"><span data-stu-id="d72f8-193">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="d72f8-194">O código acima usa um dicionário simultâneo de na memória para armazenar o tíquete de identidade e de código e restaurar a identidade depois de receber o código.</span><span class="sxs-lookup"><span data-stu-id="d72f8-194">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="d72f8-195">Em um aplicativo real, ele seria substituído por um repositório de dados persistentes.</span><span class="sxs-lookup"><span data-stu-id="d72f8-195">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="d72f8-196">É o ponto de extremidade de autorização do proprietário do recurso conceder acesso ao cliente.</span><span class="sxs-lookup"><span data-stu-id="d72f8-196">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="d72f8-197">Normalmente, ele precisa de uma interface do usuário para permitir que o usuário clicar em um botão e confirmar a concessão.</span><span class="sxs-lookup"><span data-stu-id="d72f8-197">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="d72f8-198">Middleware OWIN OAuth permite que o código do aplicativo lidar com o ponto de extremidade de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-198">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="d72f8-199">Em nosso aplicativo de exemplo, usamos um controlador MVC chamado `OAuthController` manipulá-lo.</span><span class="sxs-lookup"><span data-stu-id="d72f8-199">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="d72f8-200">Aqui está a implementação de exemplo:</span><span class="sxs-lookup"><span data-stu-id="d72f8-200">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="d72f8-201">O `Authorize` ação verificará primeiro se o usuário tiver conectado ao servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-201">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="d72f8-202">Caso contrário, o middleware de autenticação desafia o chamador a se autenticar usando o cookie "Aplicativo" e redireciona para a página de logon.</span><span class="sxs-lookup"><span data-stu-id="d72f8-202">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="d72f8-203">(Consulte o código realçado acima). Se o usuário tiver efetuado logon, ele processará a exibição Authorize, conforme mostrado abaixo:</span><span class="sxs-lookup"><span data-stu-id="d72f8-203">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="d72f8-204">Se o **Grant** botão for selecionado, o `Authorize` ação criará uma nova identidade de "Portador" e entrar com ela.</span><span class="sxs-lookup"><span data-stu-id="d72f8-204">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="d72f8-205">Ele irá disparar o servidor de autorização para gerar um token de portador e enviará de volta para o cliente com a carga JSON.</span><span class="sxs-lookup"><span data-stu-id="d72f8-205">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="d72f8-206">Concessão implícita</span><span class="sxs-lookup"><span data-stu-id="d72f8-206">Implicit Grant</span></span>

<span data-ttu-id="d72f8-207">Consulte a OAuth 2 da IETF [concessão implícita](http://tools.ietf.org/html/rfc6749#section-4.2) seção agora.</span><span class="sxs-lookup"><span data-stu-id="d72f8-207">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="d72f8-208">O [concessão implícita](http://tools.ietf.org/html/rfc6749#section-4.2) fluxo mostrado na Figura 4 é o fluxo e middleware OWIN OAuth de mapeamento que se segue.</span><span class="sxs-lookup"><span data-stu-id="d72f8-208">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="d72f8-209">Fluxo de etapas da seção de concessão implícita</span><span class="sxs-lookup"><span data-stu-id="d72f8-209">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="d72f8-210">Download de exemplo executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d72f8-210">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d72f8-211">(A) o cliente inicia o fluxo, direcionando agente do proprietário do recurso do usuário para o ponto de extremidade de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-211">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="d72f8-212">O cliente inclui seu identificador de cliente, escopo solicitado, estado local e um URI de redirecionamento para o qual o servidor de autorização enviará o agente do usuário novamente quando o acesso é concedido (ou negado).</span><span class="sxs-lookup"><span data-stu-id="d72f8-212">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="d72f8-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="d72f8-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="d72f8-214">(B) o servidor de autorização autentica o proprietário do recurso (por meio do agente do usuário) e estabelece se o proprietário do recurso concede ou nega a solicitação de acesso do cliente.</span><span class="sxs-lookup"><span data-stu-id="d72f8-214">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="d72f8-215">**&lt;Se o usuário concede acesso&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d72f8-215">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d72f8-216">(C) supondo que o proprietário do recurso concede acesso, o servidor de autorização redireciona o agente do usuário para o cliente usando o URI de redirecionamento fornecido anteriormente (na solicitação ou durante o registro do cliente).</span><span class="sxs-lookup"><span data-stu-id="d72f8-216">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="d72f8-217">...</span><span class="sxs-lookup"><span data-stu-id="d72f8-217">...</span></span> |  |
|  |  |
| <span data-ttu-id="d72f8-218">(D) o cliente solicita um token de acesso do ponto de extremidade do servidor de autorização, incluindo o código de autorização recebido na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="d72f8-218">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="d72f8-219">Ao fazer a solicitação, o cliente autentica com o servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-219">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="d72f8-220">O cliente inclui o URI de redirecionamento usado para obter o código de autorização para verificação.</span><span class="sxs-lookup"><span data-stu-id="d72f8-220">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="d72f8-221">Uma vez que já implementamos o ponto de extremidade de autorização (`OAuthController.Authorize` ação) para concessão de código de autorização, ele habilita automaticamente também o fluxo implícito.</span><span class="sxs-lookup"><span data-stu-id="d72f8-221">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="d72f8-222">Observação: `Provider.ValidateClientRedirectUri` é usado para validar a ID do cliente com a URL de redirecionamento, que protege o fluxo de concessão implícita de enviar o acesso de clientes de token para mal-intencionados ([ataque Man-in-the-middle](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="d72f8-222">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="d72f8-223">Concessão de credenciais de senha do proprietário do recurso</span><span class="sxs-lookup"><span data-stu-id="d72f8-223">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="d72f8-224">Consulte a OAuth 2 da IETF [concessão de credenciais de senha de proprietário do recurso](http://tools.ietf.org/html/rfc6749#section-4.3) seção agora.</span><span class="sxs-lookup"><span data-stu-id="d72f8-224">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="d72f8-225">O [concessão de credenciais de senha de proprietário do recurso](http://tools.ietf.org/html/rfc6749#section-4.3) fluxo mostrado na Figura 5 é o fluxo e middleware OWIN OAuth de mapeamento que se segue.</span><span class="sxs-lookup"><span data-stu-id="d72f8-225">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="d72f8-226">Fluxo de etapas da seção de concessão de credenciais de senha de proprietário do recurso</span><span class="sxs-lookup"><span data-stu-id="d72f8-226">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="d72f8-227">Download de exemplo executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d72f8-227">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d72f8-228">(A) o proprietário do recurso fornece ao cliente seu nome de usuário e senha.</span><span class="sxs-lookup"><span data-stu-id="d72f8-228">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="d72f8-229">(B) o cliente solicita um token de acesso do ponto de extremidade do servidor de autorização, incluindo as credenciais recebidas do proprietário do recurso.</span><span class="sxs-lookup"><span data-stu-id="d72f8-229">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="d72f8-230">Ao fazer a solicitação, o cliente autentica com o servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-230">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="d72f8-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d72f8-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d72f8-232">(C) o servidor de autorização autentica o cliente e valida as credenciais do proprietário de recurso e, se for válido, emite um token de acesso.</span><span class="sxs-lookup"><span data-stu-id="d72f8-232">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="d72f8-233">Aqui está a implementação de exemplo para `Provider.GrantResourceOwnerCredentials`:</span><span class="sxs-lookup"><span data-stu-id="d72f8-233">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="d72f8-234">O código acima se destina a explicar essa seção do tutorial e não deve ser usado em seguro ou aplicativos de produção.</span><span class="sxs-lookup"><span data-stu-id="d72f8-234">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="d72f8-235">Ele não verifica as credenciais de proprietários de recurso.</span><span class="sxs-lookup"><span data-stu-id="d72f8-235">It does not check the resource owners credentials.</span></span> <span data-ttu-id="d72f8-236">Ele pressupõe que cada credencial é válida e cria uma nova identidade para ele.</span><span class="sxs-lookup"><span data-stu-id="d72f8-236">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="d72f8-237">A nova identidade será usada para gerar o token de acesso e token de atualização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-237">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="d72f8-238">Substitua o código com seu próprio código de gerenciamento de conta segura.</span><span class="sxs-lookup"><span data-stu-id="d72f8-238">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="d72f8-239">Concessão de credenciais do cliente</span><span class="sxs-lookup"><span data-stu-id="d72f8-239">Client Credentials Grant</span></span>

<span data-ttu-id="d72f8-240">Consulte a OAuth 2 da IETF [concessão de credenciais de cliente](http://tools.ietf.org/html/rfc6749#section-4.4) seção agora.</span><span class="sxs-lookup"><span data-stu-id="d72f8-240">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="d72f8-241">O [concessão de credenciais de cliente](http://tools.ietf.org/html/rfc6749#section-4.4) fluxo mostrado na Figura 6 é o fluxo e middleware OWIN OAuth de mapeamento que se segue.</span><span class="sxs-lookup"><span data-stu-id="d72f8-241">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="d72f8-242">Fluxo de etapas da seção de concessão de credenciais de cliente</span><span class="sxs-lookup"><span data-stu-id="d72f8-242">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="d72f8-243">Download de exemplo executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d72f8-243">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d72f8-244">(A) o cliente autentica com o servidor de autorização e solicita um token de acesso do ponto de extremidade token.</span><span class="sxs-lookup"><span data-stu-id="d72f8-244">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="d72f8-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d72f8-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d72f8-246">(B) o servidor de autorização autentica o cliente e se for válido, emite um token de acesso.</span><span class="sxs-lookup"><span data-stu-id="d72f8-246">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="d72f8-247">Aqui está a implementação de exemplo para `Provider.GrantClientCredentials`:</span><span class="sxs-lookup"><span data-stu-id="d72f8-247">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="d72f8-248">O código acima se destina a explicar essa seção do tutorial e não deve ser usado em seguro ou aplicativos de produção.</span><span class="sxs-lookup"><span data-stu-id="d72f8-248">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="d72f8-249">Substitua o código com seu próprio código de gerenciamento de cliente segura.</span><span class="sxs-lookup"><span data-stu-id="d72f8-249">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="d72f8-250">Token de atualização</span><span class="sxs-lookup"><span data-stu-id="d72f8-250">Refresh Token</span></span>

<span data-ttu-id="d72f8-251">Consulte a OAuth 2 da IETF [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) seção agora.</span><span class="sxs-lookup"><span data-stu-id="d72f8-251">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="d72f8-252">O [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) fluxo mostrado na Figura 2 é o fluxo e middleware OWIN OAuth de mapeamento que se segue.</span><span class="sxs-lookup"><span data-stu-id="d72f8-252">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="d72f8-253">Fluxo de etapas da seção de concessão de credenciais de cliente</span><span class="sxs-lookup"><span data-stu-id="d72f8-253">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="d72f8-254">Download de exemplo executa essas etapas com:</span><span class="sxs-lookup"><span data-stu-id="d72f8-254">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="d72f8-255">(G) o cliente solicita um novo token de acesso de autenticação com o servidor de autorização e apresentando o token de atualização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-255">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="d72f8-256">Os requisitos de autenticação de cliente são baseados no tipo de cliente e nas políticas de servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-256">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="d72f8-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="d72f8-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="d72f8-258">(H) o servidor de autorização autentica o cliente e valida o token de atualização e, se for válido, emite um novo token de acesso (e, opcionalmente, um novo token de atualização).</span><span class="sxs-lookup"><span data-stu-id="d72f8-258">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="d72f8-259">Aqui está a implementação de exemplo para `Provider.GrantRefreshToken`:</span><span class="sxs-lookup"><span data-stu-id="d72f8-259">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="d72f8-260">Criar um servidor de recurso que é protegido por um Token de acesso</span><span class="sxs-lookup"><span data-stu-id="d72f8-260">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="d72f8-261">Crie um projeto de aplicativo web vazio e instale pacotes do projeto a seguir:</span><span class="sxs-lookup"><span data-stu-id="d72f8-261">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="d72f8-262">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="d72f8-262">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="d72f8-263">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="d72f8-263">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="d72f8-264">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="d72f8-264">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="d72f8-265">Crie uma classe de inicialização e configurar a autenticação e a API da Web.</span><span class="sxs-lookup"><span data-stu-id="d72f8-265">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="d72f8-266">Ver *AuthorizationServer\ResourceServer\Startup.cs* no download de exemplo.</span><span class="sxs-lookup"><span data-stu-id="d72f8-266">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="d72f8-267">Ver *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* no download de exemplo.</span><span class="sxs-lookup"><span data-stu-id="d72f8-267">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="d72f8-268">Ver *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* no download de exemplo.</span><span class="sxs-lookup"><span data-stu-id="d72f8-268">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="d72f8-269">`UseCors` método permite que o CORS para todos os domínios.</span><span class="sxs-lookup"><span data-stu-id="d72f8-269">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="d72f8-270">`UseOAuthBearerAuthentication` método permite que o middleware de autenticação de token de portador OAuth que receberá e validar o token de portador no cabeçalho de autorização na solicitação.</span><span class="sxs-lookup"><span data-stu-id="d72f8-270">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="d72f8-271">`Config.SuppressDefaultHostAuthentication` Suprime o padrão principal autenticado do aplicativo de host, portanto, todas as solicitações serão ser anônimas após esta chamada.</span><span class="sxs-lookup"><span data-stu-id="d72f8-271">`Config.SuppressDefaultHostAuthentication` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="d72f8-272">`HostAuthenticationFilter` Habilita a autenticação apenas para o tipo de autenticação especificado.</span><span class="sxs-lookup"><span data-stu-id="d72f8-272">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="d72f8-273">Nesse caso, ele é o tipo de autenticação do portador.</span><span class="sxs-lookup"><span data-stu-id="d72f8-273">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="d72f8-274">Para demonstrar a identidade autenticada, criamos um ApiController para gerar a saída de declarações do usuário atual.</span><span class="sxs-lookup"><span data-stu-id="d72f8-274">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="d72f8-275">Se o servidor de autorização e o servidor de recursos não estiverem no mesmo computador, o middleware OAuth usará as chaves do computador diferentes para criptografar e descriptografar o token de acesso de portador.</span><span class="sxs-lookup"><span data-stu-id="d72f8-275">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="d72f8-276">Para compartilhar a mesma chave privada entre os dois projetos, podemos adicionar os mesmos `machinekey` definindo em ambos *Web. config* arquivos.</span><span class="sxs-lookup"><span data-stu-id="d72f8-276">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="d72f8-277">Criar clientes OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="d72f8-277">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="d72f8-278">Podemos usar o [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) pacote do NuGet para simplificar o código do cliente.</span><span class="sxs-lookup"><span data-stu-id="d72f8-278">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="d72f8-279">Cliente de concessão de código de autorização</span><span class="sxs-lookup"><span data-stu-id="d72f8-279">Authorization Code Grant Client</span></span>

 <span data-ttu-id="d72f8-280">Esse cliente é um aplicativo MVC.</span><span class="sxs-lookup"><span data-stu-id="d72f8-280">This client is an MVC application.</span></span> <span data-ttu-id="d72f8-281">Ele vai disparar um fluxo de concessão de código de autorização para obter o acesso de token de back-end.</span><span class="sxs-lookup"><span data-stu-id="d72f8-281">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="d72f8-282">Ele tem uma única página, conforme mostrado abaixo:</span><span class="sxs-lookup"><span data-stu-id="d72f8-282">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="d72f8-283">O **autorizar** botão redirecionará o navegador para o servidor de autorização para notificar o proprietário do recurso conceder acesso a esse cliente.</span><span class="sxs-lookup"><span data-stu-id="d72f8-283">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="d72f8-284">O **Refresh** botão obterá um novo token de acesso e token de atualização usando a atualização atual token.</span><span class="sxs-lookup"><span data-stu-id="d72f8-284">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="d72f8-285">O **API de recursos protegidos do acesso** botão chamará o servidor do recurso para obter dados de declarações do usuário atual e mostrá-los na página.</span><span class="sxs-lookup"><span data-stu-id="d72f8-285">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="d72f8-286">Aqui está o código de exemplo do `HomeController` do cliente.</span><span class="sxs-lookup"><span data-stu-id="d72f8-286">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="d72f8-287">`DotNetOpenAuth` requer SSL por padrão.</span><span class="sxs-lookup"><span data-stu-id="d72f8-287">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="d72f8-288">Como nossa demonstração está usando HTTP, você precisa adicionar a configuração no arquivo de configuração a seguir:</span><span class="sxs-lookup"><span data-stu-id="d72f8-288">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="d72f8-289">Security - nunca desabilitar SSL em um aplicativo de produção.</span><span class="sxs-lookup"><span data-stu-id="d72f8-289">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="d72f8-290">Suas credenciais de logon agora estão sendo enviadas em texto não criptografado na transmissão.</span><span class="sxs-lookup"><span data-stu-id="d72f8-290">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="d72f8-291">O código acima é apenas para depuração de exemplo locais e exploração.</span><span class="sxs-lookup"><span data-stu-id="d72f8-291">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="d72f8-292">Cliente de concessão implícita</span><span class="sxs-lookup"><span data-stu-id="d72f8-292">Implicit Grant Client</span></span>

<span data-ttu-id="d72f8-293">Esse cliente está usando o JavaScript para:</span><span class="sxs-lookup"><span data-stu-id="d72f8-293">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="d72f8-294">Abra uma nova janela e redirecionar para o ponto de extremidade de autorização do servidor de autorização.</span><span class="sxs-lookup"><span data-stu-id="d72f8-294">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="d72f8-295">Obter o token de acesso de URL fragmentos quando ele redireciona de volta.</span><span class="sxs-lookup"><span data-stu-id="d72f8-295">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="d72f8-296">A imagem a seguir mostra esse processo:</span><span class="sxs-lookup"><span data-stu-id="d72f8-296">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="d72f8-297">O cliente deve ter duas páginas: uma para a home page e outro para o retorno de chamada. Aqui está o exemplo de JavaScript de código encontrado na *index. cshtml* arquivo:</span><span class="sxs-lookup"><span data-stu-id="d72f8-297">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="d72f8-298">Aqui está o retorno de chamada código de tratamento *SignIn.cshtml* arquivo:</span><span class="sxs-lookup"><span data-stu-id="d72f8-298">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="d72f8-299">Uma prática recomendada é mover o JavaScript para um arquivo externo e não inseri-la com a marcação do Razor.</span><span class="sxs-lookup"><span data-stu-id="d72f8-299">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="d72f8-300">Para manter esse exemplo simples, terem sido combinadas.</span><span class="sxs-lookup"><span data-stu-id="d72f8-300">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="d72f8-301">Cliente de concessão de credenciais de senha do proprietário do recurso</span><span class="sxs-lookup"><span data-stu-id="d72f8-301">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="d72f8-302">Podemos usa um aplicativo de console para esse cliente de demonstração.</span><span class="sxs-lookup"><span data-stu-id="d72f8-302">We uses a console app to demo this client.</span></span> <span data-ttu-id="d72f8-303">Aqui está o código:</span><span class="sxs-lookup"><span data-stu-id="d72f8-303">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="d72f8-304">Cliente de concessão de credenciais de cliente</span><span class="sxs-lookup"><span data-stu-id="d72f8-304">Client Credentials Grant Client</span></span>

<span data-ttu-id="d72f8-305">Assim como a concessão de credenciais de senha de proprietário do recurso, este é um código de aplicativo de console:</span><span class="sxs-lookup"><span data-stu-id="d72f8-305">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
