---
uid: web-api/overview/security/authentication-filters
title: Filtros de autenticação na API Web ASP.NET 2 | Microsoft Docs
author: MikeWasson
description: Um filtro de autenticação é um componente que autentica uma solicitação HTTP. API Web 2 e MVC 5 oferecem suporte a filtros de autenticação, mas diferem um pouco...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 22178890e8a5d481a80e5efdd37d3e43f1a30955
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/09/2019
ms.locfileid: "59406035"
---
# <a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="925d5-104">Filtros de autenticação na API Web ASP.NET 2</span><span class="sxs-lookup"><span data-stu-id="925d5-104">Authentication Filters in ASP.NET Web API 2</span></span>

<span data-ttu-id="925d5-105">por [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="925d5-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="925d5-106">Um filtro de autenticação é um componente que autentica uma solicitação HTTP.</span><span class="sxs-lookup"><span data-stu-id="925d5-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="925d5-107">API Web 2 e MVC 5 oferecem suporte a filtros de autenticação, mas elas podem diferir ligeiramente, principalmente em convenções de nomenclatura para a interface de filtro.</span><span class="sxs-lookup"><span data-stu-id="925d5-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="925d5-108">Este tópico descreve os filtros de autenticação de API da Web.</span><span class="sxs-lookup"><span data-stu-id="925d5-108">This topic describes Web API authentication filters.</span></span>


<span data-ttu-id="925d5-109">Filtros de autenticação permitem que você definir um esquema de autenticação para controladores ou ações individuais.</span><span class="sxs-lookup"><span data-stu-id="925d5-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="925d5-110">Dessa forma, seu aplicativo pode dar suporte a diferentes mecanismos de autenticação para recursos diferentes do HTTP.</span><span class="sxs-lookup"><span data-stu-id="925d5-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="925d5-111">Neste artigo, mostrarei o código do [autenticação básica](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) exemplo no [ http://aspnet.codeplex.com ](http://aspnet.codeplex.com).</span><span class="sxs-lookup"><span data-stu-id="925d5-111">In this article, I'll show code from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample on [http://aspnet.codeplex.com](http://aspnet.codeplex.com).</span></span> <span data-ttu-id="925d5-112">O exemplo mostra um filtro de autenticação que implementa o esquema de autenticação básica de acesso HTTP (RFC 2617).</span><span class="sxs-lookup"><span data-stu-id="925d5-112">The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="925d5-113">O filtro é implementado em uma classe chamada `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="925d5-113">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="925d5-114">Eu não mostraremos todo o código de exemplo, apenas as partes que ilustram como gravar um filtro de autenticação.</span><span class="sxs-lookup"><span data-stu-id="925d5-114">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="925d5-115">Definindo um filtro de autenticação</span><span class="sxs-lookup"><span data-stu-id="925d5-115">Setting an Authentication Filter</span></span>

<span data-ttu-id="925d5-116">Como outros filtros, os filtros de autenticação podem ser aplicadas por controlador, por ação ou globalmente a todos os controladores de API da Web.</span><span class="sxs-lookup"><span data-stu-id="925d5-116">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="925d5-117">Para aplicar um filtro de autenticação para um controlador, decore a classe de controlador com o atributo de filtro.</span><span class="sxs-lookup"><span data-stu-id="925d5-117">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="925d5-118">O código a seguir define o `[IdentityBasicAuthentication]` filtro em uma classe de controlador, que permite a autenticação básica para todas as ações do controlador.</span><span class="sxs-lookup"><span data-stu-id="925d5-118">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="925d5-119">Para aplicar o filtro a uma ação, decore a ação com o filtro.</span><span class="sxs-lookup"><span data-stu-id="925d5-119">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="925d5-120">O seguinte código define a `[IdentityBasicAuthentication]` filtro do controlador `Post` método.</span><span class="sxs-lookup"><span data-stu-id="925d5-120">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="925d5-121">Para aplicar o filtro para todos os controladores de API da Web, adicione-o para **GlobalConfiguration.Filters**.</span><span class="sxs-lookup"><span data-stu-id="925d5-121">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="925d5-122">Implementar um filtro de autenticação de API da Web</span><span class="sxs-lookup"><span data-stu-id="925d5-122">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="925d5-123">Na API da Web, implementam filtros de autenticação do [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span><span class="sxs-lookup"><span data-stu-id="925d5-123">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="925d5-124">Eles também devem herdar de **System. Attribute**, de modo a ser aplicado como atributos.</span><span class="sxs-lookup"><span data-stu-id="925d5-124">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="925d5-125">O **IAuthenticationFilter** interface tem dois métodos:</span><span class="sxs-lookup"><span data-stu-id="925d5-125">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="925d5-126">**AuthenticateAsync** autentica a solicitação, validando as credenciais na solicitação, se estiver presente.</span><span class="sxs-lookup"><span data-stu-id="925d5-126">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="925d5-127">**ChallengeAsync** adiciona um desafio de autenticação para a resposta HTTP, se necessário.</span><span class="sxs-lookup"><span data-stu-id="925d5-127">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="925d5-128">Esses métodos correspondem ao fluxo de autenticação definido em [RFC 2612](http://tools.ietf.org/html/rfc2616) e [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="925d5-128">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="925d5-129">O cliente envia as credenciais no cabeçalho de autorização.</span><span class="sxs-lookup"><span data-stu-id="925d5-129">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="925d5-130">Isso geralmente acontece depois que o cliente recebe uma resposta de 401 (não autorizado) do servidor.</span><span class="sxs-lookup"><span data-stu-id="925d5-130">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="925d5-131">No entanto, um cliente pode enviar credenciais com qualquer solicitação, não apenas depois de obter um 401.</span><span class="sxs-lookup"><span data-stu-id="925d5-131">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="925d5-132">Se o servidor não aceitará as credenciais, ela retornará uma resposta de 401 (não autorizado).</span><span class="sxs-lookup"><span data-stu-id="925d5-132">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="925d5-133">A resposta inclui um cabeçalho Www-Authenticate que contém um ou mais desafios.</span><span class="sxs-lookup"><span data-stu-id="925d5-133">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="925d5-134">Cada desafio Especifica um esquema de autenticação reconhecido pelo servidor.</span><span class="sxs-lookup"><span data-stu-id="925d5-134">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="925d5-135">O servidor também pode retornar 401 de uma solicitação anônima.</span><span class="sxs-lookup"><span data-stu-id="925d5-135">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="925d5-136">Na verdade, que normalmente é como o processo de autenticação é iniciado:</span><span class="sxs-lookup"><span data-stu-id="925d5-136">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="925d5-137">O cliente envia uma solicitação anônima.</span><span class="sxs-lookup"><span data-stu-id="925d5-137">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="925d5-138">O servidor retorna um 401.</span><span class="sxs-lookup"><span data-stu-id="925d5-138">The server returns 401.</span></span>
3. <span data-ttu-id="925d5-139">Os clientes reenvia a solicitação de credenciais.</span><span class="sxs-lookup"><span data-stu-id="925d5-139">The clients resends the request with credentials.</span></span>

<span data-ttu-id="925d5-140">Esse fluxo inclui tanto *autenticação* e *autorização* etapas.</span><span class="sxs-lookup"><span data-stu-id="925d5-140">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="925d5-141">Autenticação comprova a identidade do cliente.</span><span class="sxs-lookup"><span data-stu-id="925d5-141">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="925d5-142">Autorização determina se o cliente pode acessar um recurso específico.</span><span class="sxs-lookup"><span data-stu-id="925d5-142">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="925d5-143">Na API da Web, filtros de autenticação, lidar com a autenticação, mas não a autorização.</span><span class="sxs-lookup"><span data-stu-id="925d5-143">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="925d5-144">Autorização deve ser feita por um filtro de autorização ou dentro da ação de controlador.</span><span class="sxs-lookup"><span data-stu-id="925d5-144">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="925d5-145">Aqui está o fluxo no pipeline da API Web 2:</span><span class="sxs-lookup"><span data-stu-id="925d5-145">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="925d5-146">Antes de invocar uma ação, a API da Web cria uma lista dos filtros de autenticação para essa ação.</span><span class="sxs-lookup"><span data-stu-id="925d5-146">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="925d5-147">Isso inclui filtros com escopo da ação, o escopo do controlador e o escopo global.</span><span class="sxs-lookup"><span data-stu-id="925d5-147">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="925d5-148">Chamadas à API de Web **AuthenticateAsync** em cada filtro na lista.</span><span class="sxs-lookup"><span data-stu-id="925d5-148">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="925d5-149">Cada filtro pode validar as credenciais na solicitação.</span><span class="sxs-lookup"><span data-stu-id="925d5-149">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="925d5-150">Se qualquer filtro validado com êxito as credenciais, o filtro cria uma **IPrincipal** e a anexa à solicitação.</span><span class="sxs-lookup"><span data-stu-id="925d5-150">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="925d5-151">Um filtro também pode disparar um erro neste momento.</span><span class="sxs-lookup"><span data-stu-id="925d5-151">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="925d5-152">Nesse caso, o restante do pipeline não é executado.</span><span class="sxs-lookup"><span data-stu-id="925d5-152">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="925d5-153">Supondo que nenhum erro, a solicitação flui pelo resto do pipeline.</span><span class="sxs-lookup"><span data-stu-id="925d5-153">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="925d5-154">Por fim, a API da Web chama cada filtro de autenticação **ChallengeAsync** método.</span><span class="sxs-lookup"><span data-stu-id="925d5-154">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="925d5-155">Filtros de usam esse método para adicionar um desafio para a resposta, se necessário.</span><span class="sxs-lookup"><span data-stu-id="925d5-155">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="925d5-156">Normalmente (mas nem sempre) que deve acontecer em resposta a um erro 401.</span><span class="sxs-lookup"><span data-stu-id="925d5-156">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="925d5-157">Os diagramas a seguir mostram dois casos possíveis.</span><span class="sxs-lookup"><span data-stu-id="925d5-157">The following diagrams show two possible cases.</span></span> <span data-ttu-id="925d5-158">No primeiro, o filtro de autenticação com êxito autentica a solicitação, um filtro de autorização autoriza a solicitação e a ação do controlador retorna 200 (Okey).</span><span class="sxs-lookup"><span data-stu-id="925d5-158">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="925d5-159">No segundo exemplo, o filtro de autenticação autentica a solicitação, mas o filtro de autorização retorna 401 (não autorizado).</span><span class="sxs-lookup"><span data-stu-id="925d5-159">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="925d5-160">Nesse caso, a ação do controlador não é invocada.</span><span class="sxs-lookup"><span data-stu-id="925d5-160">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="925d5-161">O filtro de autenticação adiciona um cabeçalho Www-Authenticate à resposta.</span><span class="sxs-lookup"><span data-stu-id="925d5-161">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="925d5-162">Outras combinações são possíveis&mdash;, por exemplo, se a ação do controlador permitir solicitações anônimas, você pode ter um filtro de autenticação, mas sem autorização.</span><span class="sxs-lookup"><span data-stu-id="925d5-162">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="925d5-163">Implementando o método AuthenticateAsync</span><span class="sxs-lookup"><span data-stu-id="925d5-163">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="925d5-164">O **AuthenticateAsync** método tenta autenticar a solicitação.</span><span class="sxs-lookup"><span data-stu-id="925d5-164">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="925d5-165">Aqui está a assinatura do método:</span><span class="sxs-lookup"><span data-stu-id="925d5-165">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="925d5-166">O **AuthenticateAsync** método deve fazer o seguinte:</span><span class="sxs-lookup"><span data-stu-id="925d5-166">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="925d5-167">Nada (não operacional).</span><span class="sxs-lookup"><span data-stu-id="925d5-167">Nothing (no-op).</span></span>
2. <span data-ttu-id="925d5-168">Criar uma **IPrincipal** e defini-lo na solicitação.</span><span class="sxs-lookup"><span data-stu-id="925d5-168">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="925d5-169">Defina um resultado de erro.</span><span class="sxs-lookup"><span data-stu-id="925d5-169">Set an error result.</span></span>

<span data-ttu-id="925d5-170">Opção (1) significa que a solicitação não tinha nenhuma credencial que compreende o filtro.</span><span class="sxs-lookup"><span data-stu-id="925d5-170">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="925d5-171">Opção (2) significa que o filtro de autenticado com êxito a solicitação.</span><span class="sxs-lookup"><span data-stu-id="925d5-171">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="925d5-172">Opção (3) significa que a solicitação tinha credenciais inválidas (como a senha incorreta), que dispara uma resposta de erro.</span><span class="sxs-lookup"><span data-stu-id="925d5-172">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="925d5-173">Aqui está uma visão geral para implementar **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="925d5-173">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="925d5-174">Procure as credenciais na solicitação.</span><span class="sxs-lookup"><span data-stu-id="925d5-174">Look for credentials in the request.</span></span>
2. <span data-ttu-id="925d5-175">Se não houver nenhuma credencial, não faça nada e retornar (não operacional).</span><span class="sxs-lookup"><span data-stu-id="925d5-175">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="925d5-176">Se houver credenciais, mas o filtro não reconhece o esquema de autenticação, não faça nada e retornar (não operacional).</span><span class="sxs-lookup"><span data-stu-id="925d5-176">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="925d5-177">Outro filtro no pipeline pode compreender o esquema.</span><span class="sxs-lookup"><span data-stu-id="925d5-177">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="925d5-178">Se não houver credenciais que compreende o filtro, tente autenticá-los.</span><span class="sxs-lookup"><span data-stu-id="925d5-178">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="925d5-179">Se as credenciais sejam ruins, retornar 401, definindo `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="925d5-179">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="925d5-180">Se as credenciais forem válidas, crie uma **IPrincipal** e defina `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="925d5-180">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="925d5-181">Mostra o código a seguir a **AuthenticateAsync** método a partir de [autenticação básica](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) exemplo.</span><span class="sxs-lookup"><span data-stu-id="925d5-181">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample.</span></span> <span data-ttu-id="925d5-182">Os comentários indicam cada etapa.</span><span class="sxs-lookup"><span data-stu-id="925d5-182">The comments indicate each step.</span></span> <span data-ttu-id="925d5-183">O código mostra vários tipos de erro: Um cabeçalho de autorização sem credenciais, credenciais malformadas, e o nome de usuário/senha inválidos.</span><span class="sxs-lookup"><span data-stu-id="925d5-183">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="925d5-184">Definindo um resultado de erro</span><span class="sxs-lookup"><span data-stu-id="925d5-184">Setting an Error Result</span></span>

<span data-ttu-id="925d5-185">Se as credenciais forem inválidas, o filtro deve ser definido `context.ErrorResult` para um **IHttpActionResult** que cria uma resposta de erro.</span><span class="sxs-lookup"><span data-stu-id="925d5-185">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="925d5-186">Para obter mais informações sobre **IHttpActionResult**, consulte [resultados de ação na API Web 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="925d5-186">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="925d5-187">O exemplo de autenticação básica inclui um `AuthenticationFailureResult` classe adequada para essa finalidade.</span><span class="sxs-lookup"><span data-stu-id="925d5-187">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="925d5-188">Implementando ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="925d5-188">Implementing ChallengeAsync</span></span>

<span data-ttu-id="925d5-189">A finalidade de **ChallengeAsync** método é adicionar os desafios de autenticação para a resposta, se necessário.</span><span class="sxs-lookup"><span data-stu-id="925d5-189">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="925d5-190">Aqui está a assinatura do método:</span><span class="sxs-lookup"><span data-stu-id="925d5-190">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="925d5-191">O método é chamado em cada filtro de autenticação no pipeline de solicitação.</span><span class="sxs-lookup"><span data-stu-id="925d5-191">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="925d5-192">É importante entender que **ChallengeAsync** é chamado *antes de* a resposta HTTP é criado e, possivelmente, até mesmo antes da execução da ação de controlador.</span><span class="sxs-lookup"><span data-stu-id="925d5-192">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="925d5-193">Quando **ChallengeAsync** é chamado, `context.Result` contém um **IHttpActionResult**, que é usado posteriormente para criar a resposta HTTP.</span><span class="sxs-lookup"><span data-stu-id="925d5-193">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="925d5-194">Portanto, quando **ChallengeAsync** é chamado, você não sabe nada sobre a resposta HTTP ainda.</span><span class="sxs-lookup"><span data-stu-id="925d5-194">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="925d5-195">O **ChallengeAsync** método deve substituir o valor original da `context.Result` com uma nova **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="925d5-195">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="925d5-196">Isso **IHttpActionResult** deve encapsular original `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="925d5-196">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="925d5-197">Chamarei o original **IHttpActionResult** as *resultados interno*e o novo **IHttpActionResult** o *resultado externo*.</span><span class="sxs-lookup"><span data-stu-id="925d5-197">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="925d5-198">O resultado externo deve fazer o seguinte:</span><span class="sxs-lookup"><span data-stu-id="925d5-198">The outer result must do the following:</span></span>

1. <span data-ttu-id="925d5-199">Invoque o resultado interno para criar a resposta HTTP.</span><span class="sxs-lookup"><span data-stu-id="925d5-199">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="925d5-200">Examine a resposta.</span><span class="sxs-lookup"><span data-stu-id="925d5-200">Examine the response.</span></span>
3. <span data-ttu-id="925d5-201">Adicione um desafio de autenticação para a resposta, se necessário.</span><span class="sxs-lookup"><span data-stu-id="925d5-201">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="925d5-202">O exemplo a seguir é obtido do exemplo de autenticação básica.</span><span class="sxs-lookup"><span data-stu-id="925d5-202">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="925d5-203">Ele define uma **IHttpActionResult** para o resultado da externo.</span><span class="sxs-lookup"><span data-stu-id="925d5-203">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="925d5-204">O `InnerResult` propriedade mantém interna **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="925d5-204">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="925d5-205">O `Challenge` propriedade representa um cabeçalho de autenticação de Www.</span><span class="sxs-lookup"><span data-stu-id="925d5-205">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="925d5-206">Observe que **ExecuteAsync** primeiro chama `InnerResult.ExecuteAsync` para criar a resposta HTTP e, em seguida, adiciona o desafio, se necessário.</span><span class="sxs-lookup"><span data-stu-id="925d5-206">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="925d5-207">Verifique o código de resposta antes de adicionar o desafio.</span><span class="sxs-lookup"><span data-stu-id="925d5-207">Check the response code before adding the challenge.</span></span> <span data-ttu-id="925d5-208">A maioria dos esquemas de autenticação apenas adicionar um desafio se a resposta 401, conforme mostrado aqui.</span><span class="sxs-lookup"><span data-stu-id="925d5-208">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="925d5-209">No entanto, alguns esquemas de autenticação de adicionar um desafio para uma resposta de êxito.</span><span class="sxs-lookup"><span data-stu-id="925d5-209">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="925d5-210">Por exemplo, consulte [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="925d5-210">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="925d5-211">Dada a `AddChallengeOnUnauthorizedResult` classe, o código real no **ChallengeAsync** é simples.</span><span class="sxs-lookup"><span data-stu-id="925d5-211">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="925d5-212">Você acabou de criar o resultado e anexá-lo para `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="925d5-212">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="925d5-213">Observação: O exemplo de autenticação básica abstrai essa lógica de um pouco, colocando-o em um método de extensão.</span><span class="sxs-lookup"><span data-stu-id="925d5-213">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="925d5-214">A combinação de filtros de autenticação com autenticação no nível do Host</span><span class="sxs-lookup"><span data-stu-id="925d5-214">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="925d5-215">"Autenticação de nível de host" é executada pelo host (como o IIS), a autenticação antes da estrutura de atingir a API da Web de solicitação.</span><span class="sxs-lookup"><span data-stu-id="925d5-215">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="925d5-216">Muitas vezes, você talvez queira habilitar a autenticação de nível de host para o restante do seu aplicativo, mas desabilitá-lo para seus controladores de API da Web.</span><span class="sxs-lookup"><span data-stu-id="925d5-216">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="925d5-217">Por exemplo, um cenário típico é habilitar a autenticação de formulários no nível do host, mas usar a autenticação baseada em token para API da Web.</span><span class="sxs-lookup"><span data-stu-id="925d5-217">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="925d5-218">Para desabilitar a autenticação em nível de host dentro do pipeline da API da Web, chame `config.SuppressHostPrincipal()` em sua configuração.</span><span class="sxs-lookup"><span data-stu-id="925d5-218">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="925d5-219">Isso faz com que a API da Web remover o **IPrincipal** de qualquer solicitação que entra o pipeline da API Web.</span><span class="sxs-lookup"><span data-stu-id="925d5-219">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="925d5-220">Na verdade, ele &quot;un-autentica&quot; a solicitação.</span><span class="sxs-lookup"><span data-stu-id="925d5-220">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="925d5-221">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="925d5-221">Additional Resources</span></span>

<span data-ttu-id="925d5-222">[Filtros de segurança de API da Web do ASP.NET](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="925d5-222">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
