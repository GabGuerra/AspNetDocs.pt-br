---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: Impedindo ataques do solicitação intersite forjada (CSRF) no ASP.NET MVC
author: MikeWasson
description: Descreve o ataque de solicitação intersite forjada (CSRF) e como implementar medidas de anti-CSRF no ASP.NET MVC da Web.
ms.author: riande
ms.date: 12/12/2012
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 5fb0f8bcc9e587ba4fbbf2b857d3bf7adcaafb94
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/09/2019
ms.locfileid: "59392021"
---
# <a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-mvc-application"></a><span data-ttu-id="df6a9-103">Impedindo ataques do solicitação intersite forjada (CSRF) no aplicativo ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="df6a9-103">Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET MVC Application</span></span>

<span data-ttu-id="df6a9-104">por [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="df6a9-104">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

<span data-ttu-id="df6a9-105">Falsificação de solicitação entre sites (CSRF) é um ataque em que um site mal-intencionado envia uma solicitação para um site vulnerável no qual o usuário fez logon</span><span class="sxs-lookup"><span data-stu-id="df6a9-105">Cross-Site Request Forgery (CSRF) is an attack where a malicious site sends a request to a vulnerable site where the user is currently logged in</span></span>

<span data-ttu-id="df6a9-106">Aqui está um exemplo de um ataque CSRF:</span><span class="sxs-lookup"><span data-stu-id="df6a9-106">Here is an example of a CSRF attack:</span></span>

1. <span data-ttu-id="df6a9-107">Um usuário faz logon em `www.example.com` usando a autenticação de formulários.</span><span class="sxs-lookup"><span data-stu-id="df6a9-107">A user logs into `www.example.com` using forms authentication.</span></span>
2. <span data-ttu-id="df6a9-108">O servidor autentica o usuário.</span><span class="sxs-lookup"><span data-stu-id="df6a9-108">The server authenticates the user.</span></span> <span data-ttu-id="df6a9-109">A resposta do servidor inclui um cookie de autenticação.</span><span class="sxs-lookup"><span data-stu-id="df6a9-109">The response from the server includes an authentication cookie.</span></span>
3. <span data-ttu-id="df6a9-110">Sem fazer logoff, o usuário visitar um site mal-intencionado.</span><span class="sxs-lookup"><span data-stu-id="df6a9-110">Without logging out, the user visits a malicious web site.</span></span> <span data-ttu-id="df6a9-111">Este site mal-intencionado contém o formulário HTML a seguir:</span><span class="sxs-lookup"><span data-stu-id="df6a9-111">This malicious site contains the following HTML form:</span></span> 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    <span data-ttu-id="df6a9-112">Observe que a ação de formulário faz a postagem para o site vulnerável, não para o site mal-intencionado.</span><span class="sxs-lookup"><span data-stu-id="df6a9-112">Notice that the form action posts to the vulnerable site, not to the malicious site.</span></span> <span data-ttu-id="df6a9-113">Essa é a parte de "site cruzado" de CSRF.</span><span class="sxs-lookup"><span data-stu-id="df6a9-113">This is the "cross-site" part of CSRF.</span></span>
4. <span data-ttu-id="df6a9-114">O usuário clica no botão Enviar.</span><span class="sxs-lookup"><span data-stu-id="df6a9-114">The user clicks the submit button.</span></span> <span data-ttu-id="df6a9-115">O navegador inclui o cookie de autenticação com a solicitação.</span><span class="sxs-lookup"><span data-stu-id="df6a9-115">The browser includes the authentication cookie with the request.</span></span>
5. <span data-ttu-id="df6a9-116">A solicitação é executada no servidor com o contexto de autenticação do usuário e pode fazer qualquer coisa que um usuário autenticado tem permissão para fazer.</span><span class="sxs-lookup"><span data-stu-id="df6a9-116">The request runs on the server with the user's authentication context, and can do anything that an authenticated user is allowed to do.</span></span>

<span data-ttu-id="df6a9-117">Embora este exemplo requer que o usuário clicar no botão do formulário, a página mal-intencionada pode apenas executar facilmente um script que envia o formulário automaticamente.</span><span class="sxs-lookup"><span data-stu-id="df6a9-117">Although this example requires the user to click the form button, the malicious page could just as easily run a script that submits the form automatically.</span></span> <span data-ttu-id="df6a9-118">Além disso, usando o SSL não impede que um ataque CSRF, porque o site mal-intencionado pode enviar uma solicitação de "https://".</span><span class="sxs-lookup"><span data-stu-id="df6a9-118">Moreover, using SSL does not prevent a CSRF attack, because the malicious site can send an "https://" request.</span></span>

<span data-ttu-id="df6a9-119">Normalmente, ataques de CSRF são possíveis em relação a sites da web que usam cookies para autenticação, porque os navegadores enviam a todos os cookies relevantes para o site de destino.</span><span class="sxs-lookup"><span data-stu-id="df6a9-119">Typically, CSRF attacks are possible against web sites that use cookies for authentication, because browsers send all relevant cookies to the destination web site.</span></span> <span data-ttu-id="df6a9-120">No entanto, ataques de CSRF não são limitados a exploração de cookies.</span><span class="sxs-lookup"><span data-stu-id="df6a9-120">However, CSRF attacks are not limited to exploiting cookies.</span></span> <span data-ttu-id="df6a9-121">Por exemplo, a autenticação básica e Digest também são vulneráveis.</span><span class="sxs-lookup"><span data-stu-id="df6a9-121">For example, Basic and Digest authentication are also vulnerable.</span></span> <span data-ttu-id="df6a9-122">Depois de um usuário faz logon com a autenticação básica ou Digest.</span><span class="sxs-lookup"><span data-stu-id="df6a9-122">After a user logs in with Basic or Digest authentication.</span></span> <span data-ttu-id="df6a9-123">o navegador automaticamente envia as credenciais até que a sessão termina.</span><span class="sxs-lookup"><span data-stu-id="df6a9-123">the browser automatically sends the credentials until the session ends.</span></span>

## <a name="anti-forgery-tokens"></a><span data-ttu-id="df6a9-124">Tokens Antifalsificação</span><span class="sxs-lookup"><span data-stu-id="df6a9-124">Anti-Forgery Tokens</span></span>

<span data-ttu-id="df6a9-125">Para ajudar a impedir ataques CSRF, o ASP.NET MVC usa tokens antifalsificação, também chamado de *solicitar tokens de verificação*.</span><span class="sxs-lookup"><span data-stu-id="df6a9-125">To help prevent CSRF attacks, ASP.NET MVC uses anti-forgery tokens, also called *request verification tokens*.</span></span>

1. <span data-ttu-id="df6a9-126">O cliente solicita uma página HTML que contém um formulário.</span><span class="sxs-lookup"><span data-stu-id="df6a9-126">The client requests an HTML page that contains a form.</span></span>
2. <span data-ttu-id="df6a9-127">O servidor inclui dois tokens na resposta.</span><span class="sxs-lookup"><span data-stu-id="df6a9-127">The server includes two tokens in the response.</span></span> <span data-ttu-id="df6a9-128">Um token é enviado como um cookie.</span><span class="sxs-lookup"><span data-stu-id="df6a9-128">One token is sent as a cookie.</span></span> <span data-ttu-id="df6a9-129">O outro é colocado em um campo de formulário oculto.</span><span class="sxs-lookup"><span data-stu-id="df6a9-129">The other is placed in a hidden form field.</span></span> <span data-ttu-id="df6a9-130">Os tokens são gerados aleatoriamente, de modo que um adversário não é possível prever os valores.</span><span class="sxs-lookup"><span data-stu-id="df6a9-130">The tokens are generated randomly so that an adversary cannot guess the values.</span></span>
3. <span data-ttu-id="df6a9-131">Quando o cliente envia o formulário, ele deve enviar os dois tokens de volta para o servidor.</span><span class="sxs-lookup"><span data-stu-id="df6a9-131">When the client submits the form, it must send both tokens back to the server.</span></span> <span data-ttu-id="df6a9-132">O cliente envia o token de cookie como um cookie e envia o token de formulário dentro dos dados de formulário.</span><span class="sxs-lookup"><span data-stu-id="df6a9-132">The client sends the cookie token as a cookie, and it sends the form token inside the form data.</span></span> <span data-ttu-id="df6a9-133">(Um cliente de navegador faz isso automaticamente quando o usuário envia o formulário.)</span><span class="sxs-lookup"><span data-stu-id="df6a9-133">(A browser client automatically does this when the user submits the form.)</span></span>
4. <span data-ttu-id="df6a9-134">Se uma solicitação não inclui ambos os tokens, o servidor não permite a solicitação.</span><span class="sxs-lookup"><span data-stu-id="df6a9-134">If a request does not include both tokens, the server disallows the request.</span></span>

<span data-ttu-id="df6a9-135">Aqui está um exemplo de um formulário HTML com um token de formulário oculto:</span><span class="sxs-lookup"><span data-stu-id="df6a9-135">Here is an example of an HTML form with a hidden form token:</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

<span data-ttu-id="df6a9-136">Tokens antifalsificação funciona porque a página mal-intencionados não é possível ler os tokens do usuário, devido às diretivas de mesma origem.</span><span class="sxs-lookup"><span data-stu-id="df6a9-136">Anti-forgery tokens work because the malicious page cannot read the user's tokens, due to same-origin policies.</span></span> <span data-ttu-id="df6a9-137">([Políticas de mesma origem](http://www.w3.org/Security/wiki/Same_Origin_Policy) evitar que os documentos hospedados em dois locais diferentes de acessar o conteúdo uns dos outros.</span><span class="sxs-lookup"><span data-stu-id="df6a9-137">([Same-origin policies](http://www.w3.org/Security/wiki/Same_Origin_Policy) prevent documents hosted on two different sites from accessing each other's content.</span></span> <span data-ttu-id="df6a9-138">Portanto, no exemplo anterior, a página mal-intencionado pode enviar solicitações para exemplo.com, mas ele não é possível ler a resposta.)</span><span class="sxs-lookup"><span data-stu-id="df6a9-138">So in the earlier example, the malicious page can send requests to example.com, but it cannot read the response.)</span></span>

<span data-ttu-id="df6a9-139">Para impedir ataques CSRF, use tokens antifalsificação com qualquer protocolo de autenticação em que o navegador envia silenciosamente credenciais depois que o usuário fizer logon.</span><span class="sxs-lookup"><span data-stu-id="df6a9-139">To prevent CSRF attacks, use anti-forgery tokens with any authentication protocol where the browser silently sends credentials after the user logs in.</span></span> <span data-ttu-id="df6a9-140">Isso inclui os protocolos de autenticação baseada em cookie, como autenticação de formulários, bem como protocolos, como autenticação básica e Digest.</span><span class="sxs-lookup"><span data-stu-id="df6a9-140">This includes cookie-based authentication protocols, such as forms authentication, as well as protocols such as Basic and Digest authentication.</span></span>

<span data-ttu-id="df6a9-141">Você deve exigir tokens antifalsificação para todos os métodos nonsafe (POST, PUT, DELETE).</span><span class="sxs-lookup"><span data-stu-id="df6a9-141">You should require anti-forgery tokens for any nonsafe methods (POST, PUT, DELETE).</span></span> <span data-ttu-id="df6a9-142">Além disso, certifique-se de que métodos seguros (GET, HEAD) não tem nenhum efeito colateral.</span><span class="sxs-lookup"><span data-stu-id="df6a9-142">Also, make sure that safe methods (GET, HEAD) do not have any side effects.</span></span> <span data-ttu-id="df6a9-143">Além disso, se você habilitar o suporte de domínio cruzado, como o CORS ou JSONP, até mesmo seguros métodos como GET são vulneráveis a ataques de CSRF, permitindo que o invasor leia dados potencialmente confidenciais.</span><span class="sxs-lookup"><span data-stu-id="df6a9-143">Moreover, if you enable cross-domain support, such as CORS or JSONP, then even safe methods like GET are potentially vulnerable to CSRF attacks, allowing the attacker to read potentially sensitive data.</span></span>

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a><span data-ttu-id="df6a9-144">Tokens Antifalsificação no ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="df6a9-144">Anti-Forgery Tokens in ASP.NET MVC</span></span>

<span data-ttu-id="df6a9-145">Para adicionar os tokens antifalsificação para uma página Razor, use o **HtmlHelper.AntiForgeryToken** método auxiliar:</span><span class="sxs-lookup"><span data-stu-id="df6a9-145">To add the anti-forgery tokens to a Razor page, use the **HtmlHelper.AntiForgeryToken** helper method:</span></span>

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

<span data-ttu-id="df6a9-146">Esse método adiciona o campo de formulário oculto e também define o token de cookie.</span><span class="sxs-lookup"><span data-stu-id="df6a9-146">This method adds the hidden form field and also sets the cookie token.</span></span>

## <a name="anti-csrf-and-ajax"></a><span data-ttu-id="df6a9-147">Anti-CSRF e AJAX</span><span class="sxs-lookup"><span data-stu-id="df6a9-147">Anti-CSRF and AJAX</span></span>

<span data-ttu-id="df6a9-148">O token de formulário pode ser um problema para solicitações AJAX, pois uma solicitação AJAX pode enviar dados JSON, não os dados de formulário HTML.</span><span class="sxs-lookup"><span data-stu-id="df6a9-148">The form token can be a problem for AJAX requests, because an AJAX request might send JSON data, not HTML form data.</span></span> <span data-ttu-id="df6a9-149">Uma solução é enviar os tokens em um cabeçalho HTTP personalizado.</span><span class="sxs-lookup"><span data-stu-id="df6a9-149">One solution is to send the tokens in a custom HTTP header.</span></span> <span data-ttu-id="df6a9-150">O código a seguir usa a sintaxe do Razor para gerar os tokens e, em seguida, adiciona os tokens a uma solicitação AJAX.</span><span class="sxs-lookup"><span data-stu-id="df6a9-150">The following code uses Razor syntax to generate the tokens, and then adds the tokens to an AJAX request.</span></span> <span data-ttu-id="df6a9-151">Os tokens são gerados no servidor chamando **AntiForgery.GetTokens**.</span><span class="sxs-lookup"><span data-stu-id="df6a9-151">The tokens are generated at the server by calling **AntiForgery.GetTokens**.</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

<span data-ttu-id="df6a9-152">Quando você processa a solicitação, extraia os tokens do cabeçalho de solicitação.</span><span class="sxs-lookup"><span data-stu-id="df6a9-152">When you process the request, extract the tokens from the request header.</span></span> <span data-ttu-id="df6a9-153">Em seguida, chame o **Antiforgery** método para validar os tokens.</span><span class="sxs-lookup"><span data-stu-id="df6a9-153">Then call the **AntiForgery.Validate** method to validate the tokens.</span></span> <span data-ttu-id="df6a9-154">O **validar** método gera uma exceção se os tokens não forem válidos.</span><span class="sxs-lookup"><span data-stu-id="df6a9-154">The **Validate** method throws an exception if the tokens are not valid.</span></span>

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]
