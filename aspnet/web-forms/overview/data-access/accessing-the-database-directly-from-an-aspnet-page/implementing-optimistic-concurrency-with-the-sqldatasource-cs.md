---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
title: Implementando a simultaneidade otimista com o SqlDataSource (c#) | Microsoft Docs
author: rick-anderson
description: Neste tutorial, examine os conceitos básicos de controle de simultaneidade otimista e, em seguida, explore como implementá-lo usando o controle SqlDataSource.
ms.author: riande
ms.date: 02/20/2007
ms.assetid: df999966-ac48-460e-b82b-4877a57d6ab9
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
msc.type: authoredcontent
ms.openlocfilehash: f2590e8e7712d719eb89403ef839f03066a93d2b
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 03/01/2019
ms.locfileid: "57036073"
---
<a name="implementing-optimistic-concurrency-with-the-sqldatasource-c"></a><span data-ttu-id="ef5e6-103">Implementar a simultaneidade otimista com o SqlDataSource (C#)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-103">Implementing Optimistic Concurrency with the SqlDataSource (C#)</span></span>
====================
<span data-ttu-id="ef5e6-104">por [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="ef5e6-105">[Baixe o aplicativo de exemplo](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) ou [baixar PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-105">[Download Sample App](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) or [Download PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span></span>

> <span data-ttu-id="ef5e6-106">Neste tutorial, examine os conceitos básicos de controle de simultaneidade otimista e, em seguida, explore como implementá-lo usando o controle SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-106">In this tutorial we review the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource control.</span></span>


## <a name="introduction"></a><span data-ttu-id="ef5e6-107">Introdução</span><span class="sxs-lookup"><span data-stu-id="ef5e6-107">Introduction</span></span>

<span data-ttu-id="ef5e6-108">O tutorial anterior, examinamos como adicionar a inserção, atualização e exclusão de recursos para o controle SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-108">In the preceding tutorial we examined how to add inserting, updating, and deleting capabilities to the SqlDataSource control.</span></span> <span data-ttu-id="ef5e6-109">Em resumo, para fornecer esses recursos que precisávamos especificar correspondente `INSERT`, `UPDATE`, ou `DELETE` instrução SQL no controle s `InsertCommand`, `UpdateCommand`, ou `DeleteCommand` propriedades, junto com o apropriada parâmetros de `InsertParameters`, `UpdateParameters`, e `DeleteParameters` coleções.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-109">In short, to provide these features we needed to specify the corresponding `INSERT`, `UPDATE`, or `DELETE` SQL statement in the control s `InsertCommand`, `UpdateCommand`, or `DeleteCommand` properties, along with the appropriate parameters in the `InsertParameters`, `UpdateParameters`, and `DeleteParameters` collections.</span></span> <span data-ttu-id="ef5e6-110">Embora essas propriedades e coleções podem ser especificadas manualmente, o botão Avançado do s de Assistente Configurar fonte de dados oferece um gerar `INSERT`, `UPDATE`, e `DELETE` caixa de seleção de instruções que irá criar automaticamente essas instruções com base no `SELECT` instrução.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-110">While these properties and collections can be specified manually, the Configure Data Source wizard s Advanced button offers a Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox that will auto-create these statements based on the `SELECT` statement.</span></span>

<span data-ttu-id="ef5e6-111">Juntamente com o gere `INSERT`, `UPDATE`, e `DELETE` instruções de caixa de seleção, a caixa de diálogo Advanced SQL Generation Options inclui uma opção de simultaneidade otimista de uso (veja a Figura 1).</span><span class="sxs-lookup"><span data-stu-id="ef5e6-111">Along with the Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox, the Advanced SQL Generation Options dialog box includes a Use optimistic concurrency option (see Figure 1).</span></span> <span data-ttu-id="ef5e6-112">Quando marcada, o `WHERE` cláusulas em gerada automaticamente `UPDATE` e `DELETE` instruções são modificadas para executar apenas a atualização ou exclusão se o t de realizada de dados banco de dados subjacente foi modificada desde que o usuário pela última vez carregados os dados na grade.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-112">When checked, the `WHERE` clauses in the autogenerated `UPDATE` and `DELETE` statements are modified to only perform the update or delete if the underlying database data hasn t been modified since the user last loaded the data into the grid.</span></span>


![Você pode adicionar suporte à simultaneidade otimista de avançada caixa de diálogo de opções de geração SQL](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.gif)

<span data-ttu-id="ef5e6-114">**Figura 1**: Você pode adicionar suporte à simultaneidade otimista de avançada caixa de diálogo de opções de geração SQL</span><span class="sxs-lookup"><span data-stu-id="ef5e6-114">**Figure 1**: You Can Add Optimistic Concurrency Support from the Advanced SQL Generation Options Dialog Box</span></span>


<span data-ttu-id="ef5e6-115">Volta a [Implementando a simultaneidade otimista](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial, examinamos os conceitos básicos do controle de simultaneidade otimista e como adicioná-lo a ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-115">Back in the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial we examined the fundamentals of optimistic concurrency control and how to add it to the ObjectDataSource.</span></span> <span data-ttu-id="ef5e6-116">Neste tutorial, vamos Retocar essenciais do controle de simultaneidade otimista e, em seguida, explore como implementá-lo usando o SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-116">In this tutorial we'll retouch on the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource.</span></span>

## <a name="a-recap-of-optimistic-concurrency"></a><span data-ttu-id="ef5e6-117">Uma recapitulação de simultaneidade otimista</span><span class="sxs-lookup"><span data-stu-id="ef5e6-117">A Recap of Optimistic Concurrency</span></span>

<span data-ttu-id="ef5e6-118">Para aplicativos web que permitem que vários usuários simultâneos para editar ou excluir os mesmos dados, existe uma possibilidade de que um usuário pode substituir acidentalmente as alterações de s outro.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-118">For web applications that allow multiple, simultaneous users to edit or delete the same data, there exists a possibility that one user may accidentally overwrite another s changes.</span></span> <span data-ttu-id="ef5e6-119">No [Implementando a simultaneidade otimista](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial forneci o exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-119">In the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial I provided the following example:</span></span>

<span data-ttu-id="ef5e6-120">Imagine-se de que ambos dois usuários, Jisun e Sam, foram visitar uma página em um aplicativo que os visitantes para atualizar e excluir produtos por meio de um controle GridView de permissão.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-120">Imagine that two users, Jisun and Sam, were both visiting a page in an application that allowed visitors to update and delete products through a GridView control.</span></span> <span data-ttu-id="ef5e6-121">Ambos clique no botão Editar para Chai quase ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-121">Both click the Edit button for Chai around the same time.</span></span> <span data-ttu-id="ef5e6-122">Jisun altera o nome do produto para Chai chá e clica no botão de atualização.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-122">Jisun changes the product name to Chai Tea and clicks the Update button.</span></span> <span data-ttu-id="ef5e6-123">O resultado é um `UPDATE` instrução é enviada para o banco de dados que define *todas as* dos campos atualizáveis produto s (mesmo que Jisun atualizadas apenas um campo, `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="ef5e6-123">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product s updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="ef5e6-124">Neste momento, o banco de dados tem os valores Chai chá, a categoria de bebidas, líquidos exóticos fornecedor, e assim por diante para este produto específico.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-124">At this point in time, the database has the values Chai Tea, the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="ef5e6-125">No entanto, o GridView na tela do Sam s ainda mostra o nome do produto na linha de GridView editável como Chai.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-125">However, the GridView on Sam s screen still shows the product name in the editable GridView row as Chai.</span></span> <span data-ttu-id="ef5e6-126">Alguns segundos depois de alterações de s Jisun foram confirmadas, Sam atualiza a categoria para Condimentos e clica em Atualizar.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-126">A few seconds after Jisun s changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="ef5e6-127">Isso resulta em uma `UPDATE` instrução enviada ao banco de dados que define o nome do produto a Chai, o `CategoryID` Condimentos categoria ID correspondente, e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-127">This results in an `UPDATE` statement sent to the database that sets the product name to Chai, the `CategoryID` to the corresponding Condiments category ID, and so on.</span></span> <span data-ttu-id="ef5e6-128">Alterações de s Jisun para o nome do produto foram substituídas.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-128">Jisun s changes to the product name have been overwritten.</span></span>

<span data-ttu-id="ef5e6-129">Figura 2 ilustra essa interação.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-129">Figure 2 illustrates this interaction.</span></span>


<span data-ttu-id="ef5e6-130">[![Quando dois usuários simultaneamente atualizam um registro lá s potencial para um usuário s é alterada para substituir os outros s](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-130">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span></span>

<span data-ttu-id="ef5e6-131">**Figura 2**: Quando dois usuários simultaneamente atualizar um registro lá s potencial para um usuário s alterações para substituir os outros s ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="ef5e6-131">**Figure 2**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span></span>


<span data-ttu-id="ef5e6-132">Para impedir que esse cenário abrindo um formulário da [controle de simultaneidade](http://en.wikipedia.org/wiki/Concurrency_control) deve ser implementado.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-132">To prevent this scenario from unfolding, a form of [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) must be implemented.</span></span> <span data-ttu-id="ef5e6-133">[A simultaneidade otimista](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) o foco deste tutorial funciona na suposição de que embora possa haver conflitos de simultaneidade vira e mexe, a grande maioria das vezes esses conflitos ganharam t surgir.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-133">[Optimistic concurrency](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) the focus of this tutorial works on the assumption that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won t arise.</span></span> <span data-ttu-id="ef5e6-134">Portanto, se ocorrer um conflito, controle de simultaneidade otimista simplesmente informa ao usuário que suas alterações pode ser salva porque outro usuário modificou os mesmos dados.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-134">Therefore, if a conflict does arise, optimistic concurrency control simply informs the user that their changes can t be saved because another user has modified the same data.</span></span>

> [!NOTE]
> <span data-ttu-id="ef5e6-135">Para aplicativos em que ele é presumido que haja muitos conflitos de simultaneidade ou se tais conflitos não são toleráveis, em seguida, controle de simultaneidade pessimista pode ser usado em vez disso.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-135">For applications where it is assumed that there will be many concurrency conflicts or if such conflicts are not tolerable, then pessimistic concurrency control can be used instead.</span></span> <span data-ttu-id="ef5e6-136">Voltar para o [Implementando a simultaneidade otimista](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial para uma discussão mais completa sobre o controle de simultaneidade pessimista.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-136">Refer back to the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial for a more thorough discussion on pessimistic concurrency control.</span></span>


<span data-ttu-id="ef5e6-137">Controle de simultaneidade otimista funciona, garantindo que o registro que está sendo atualizada ou excluída tem os mesmos valores de quando a atualização ou exclusão de processo iniciado.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-137">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="ef5e6-138">Por exemplo, ao clicar no botão Editar em um GridView editável, os valores de registro s são de leitura do banco de dados e exibidos em caixas de texto e outros controles de Web.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-138">For example, when clicking the Edit button in an editable GridView, the record s values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="ef5e6-139">Esses valores originais são salvos por GridView.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-139">These original values are saved by the GridView.</span></span> <span data-ttu-id="ef5e6-140">Posteriormente, depois que o usuário faz as alterações dela e clica no botão de atualização, o `UPDATE` instrução usada deve levar em conta os valores originais e os novos valores e só atualizar o registro de banco de dados subjacente se os valores originais que o usuário iniciou a edição são idênticos aos valores ainda no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-140">Later, after the user makes her changes and clicks the Update button, the `UPDATE` statement used must take into account the original values plus the new values and only update the underlying database record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="ef5e6-141">Figura 3 ilustra essa sequência de eventos.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-141">Figure 3 depicts this sequence of events.</span></span>


<span data-ttu-id="ef5e6-142">[![Para a atualização ou exclusão seja bem-sucedida, os valores originais devem ser iguais aos valores atuais do banco de dados](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-142">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span></span>

<span data-ttu-id="ef5e6-143">**Figura 3**: Para a atualização ou exclusão para forem bem-sucedidas, o Original valores deve ser igual aos valores atuais do banco de dados ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="ef5e6-143">**Figure 3**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span></span>


<span data-ttu-id="ef5e6-144">Há várias abordagens para implementar a simultaneidade otimista (consulte [Peter A. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp) s [Optmistic simultaneidade atualizando lógica](http://www.eggheadcafe.com/articles/20050719.asp) para examinar uma série de opções).</span><span class="sxs-lookup"><span data-stu-id="ef5e6-144">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp) s [Optmistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="ef5e6-145">A técnica usada pelo SqlDataSource (bem como pelo ADO.NET digitado conjuntos de dados usados em nossa camada de acesso a dados) aumenta a `WHERE` cláusula para incluir uma comparação de todos os valores originais.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-145">The technique used by the SqlDataSource (as well as by the ADO.NET Typed DataSets used in our Data Access Layer) augments the `WHERE` clause to include a comparison of all of the original values.</span></span> <span data-ttu-id="ef5e6-146">O seguinte `UPDATE` instrução, por exemplo, atualiza o nome e o preço de um produto somente se os valores atuais do banco de dados são iguais aos valores que foram originalmente recuperados ao atualizar o registro em um GridView.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-146">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="ef5e6-147">O `@ProductName` e `@UnitPrice` parâmetros contêm os novos valores inseridos pelo usuário, enquanto `@original_ProductName` e `@original_UnitPrice` contêm os valores que foram carregados originalmente no GridView, quando o botão de edição foi clicado:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-147">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample1.sql)]

<span data-ttu-id="ef5e6-148">Como veremos neste tutorial, permitindo o controle de simultaneidade otimista com o SqlDataSource é tão simple quanto marcar uma caixa de seleção.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-148">As we'll see in this tutorial, enabling optimistic concurrency control with the SqlDataSource is as simple as checking a checkbox.</span></span>

## <a name="step-1-creating-a-sqldatasource-that-supports-optimistic-concurrency"></a><span data-ttu-id="ef5e6-149">Etapa 1: Criando um SqlDataSource que dá suporte à simultaneidade otimista</span><span class="sxs-lookup"><span data-stu-id="ef5e6-149">Step 1: Creating a SqlDataSource that Supports Optimistic Concurrency</span></span>

<span data-ttu-id="ef5e6-150">Comece abrindo o `OptimisticConcurrency.aspx` página a partir de `SqlDataSource` pasta.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-150">Start by opening the `OptimisticConcurrency.aspx` page from the `SqlDataSource` folder.</span></span> <span data-ttu-id="ef5e6-151">Arraste um controle SqlDataSource da caixa de ferramentas para o Designer, as configurações de seu `ID` propriedade para `ProductsDataSourceWithOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-151">Drag a SqlDataSource control from the Toolbox onto the Designer, settings its `ID` property to `ProductsDataSourceWithOptimisticConcurrency`.</span></span> <span data-ttu-id="ef5e6-152">Em seguida, clique no link configurar fonte de dados do que a marca inteligente do controle s.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-152">Next, click on the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="ef5e6-153">Na primeira tela do assistente, escolha para trabalhar com o `NORTHWINDConnectionString` e clique em Avançar.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-153">From the first screen in the wizard, choose to work with the `NORTHWINDConnectionString` and click Next.</span></span>


<span data-ttu-id="ef5e6-154">[![Optar por trabalhar com o NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-154">[![Choose to Work with the NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span></span>

<span data-ttu-id="ef5e6-155">**Figura 4**: Optar por trabalhar com o `NORTHWINDConnectionString` ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="ef5e6-155">**Figure 4**: Choose to Work with the `NORTHWINDConnectionString` ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span></span>


<span data-ttu-id="ef5e6-156">Para este exemplo, estaremos adicionando um GridView que permite que os usuários editem o `Products` tabela.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-156">For this example we'll be adding a GridView that enables users to edit the `Products` table.</span></span> <span data-ttu-id="ef5e6-157">Portanto, de configurar a tela de instrução Select, escolha o `Products` da tabela na lista suspensa e selecione o `ProductID`, `ProductName`, `UnitPrice`, e `Discontinued` colunas, conforme mostrado na Figura 5.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-157">Therefore, from the Configure the Select Statement screen, choose the `Products` table from the drop-down list and select the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` columns, as shown in Figure 5.</span></span>


<span data-ttu-id="ef5e6-158">[![Da tabela produtos, retornar o ProductID, ProductName, UnitPrice e colunas descontinuadas](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-158">[![From the Products Table, Return the ProductID, ProductName, UnitPrice, and Discontinued Columns](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span></span>

<span data-ttu-id="ef5e6-159">**Figura 5**: Dos `Products` da tabela, retornar o `ProductID`, `ProductName`, `UnitPrice`, e `Discontinued` colunas ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="ef5e6-159">**Figure 5**: From the `Products` Table, Return the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` Columns ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span></span>


<span data-ttu-id="ef5e6-160">Depois de escolher as colunas, clique no botão Avançado para abrir a caixa de diálogo Advanced SQL Generation Options.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-160">After picking the columns, click the Advanced button to bring up the Advanced SQL Generation Options dialog box.</span></span> <span data-ttu-id="ef5e6-161">Verifique o gere `INSERT`, `UPDATE`, e `DELETE` instruções e Use as caixas de seleção de simultaneidade otimista e clique em Okey (consulte novamente a Figura 1 para uma captura de tela).</span><span class="sxs-lookup"><span data-stu-id="ef5e6-161">Check the Generate `INSERT`, `UPDATE`, and `DELETE` statements and Use optimistic concurrency checkboxes and click OK (refer back to Figure 1 for a screenshot).</span></span> <span data-ttu-id="ef5e6-162">Conclua o assistente clicando em Avançar e em seguida concluir.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-162">Complete the wizard by clicking Next, then Finish.</span></span>

<span data-ttu-id="ef5e6-163">Depois de concluir o Assistente Configurar fonte de dados, reserve um tempo para examinar resultante `DeleteCommand` e `UpdateCommand` propriedades e o `DeleteParameters` e `UpdateParameters` coleções.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-163">After completing the Configure Data Source wizard, take a moment to examine the resulting `DeleteCommand` and `UpdateCommand` properties and the `DeleteParameters` and `UpdateParameters` collections.</span></span> <span data-ttu-id="ef5e6-164">A maneira mais fácil de fazer isso é clicar na guia origem no canto inferior esquerdo para ver a sintaxe declarativa de s de página.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-164">The easiest way to do this is to click on the Source tab in the lower left corner to see the page s declarative syntax.</span></span> <span data-ttu-id="ef5e6-165">Lá você encontrará um `UpdateCommand` valor:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-165">There you will find an `UpdateCommand` value of:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample2.sql)]

<span data-ttu-id="ef5e6-166">Com sete parâmetros de `UpdateParameters` coleção:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-166">With seven parameters in the `UpdateParameters` collection:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample3.aspx)]

<span data-ttu-id="ef5e6-167">Da mesma forma, o `DeleteCommand` propriedade e `DeleteParameters` coleção deve ser semelhante ao seguinte:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-167">Similarly, the `DeleteCommand` property and `DeleteParameters` collection should look like the following:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample4.sql)]


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample5.aspx)]

<span data-ttu-id="ef5e6-168">Além de ampliar as `WHERE` cláusulas do `UpdateCommand` e `DeleteCommand` propriedades (e adicionando os parâmetros adicionais para as coleções de parâmetro respectivos), selecionando o uso otimista de simultaneidade opção ajusta duas outras propriedades:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-168">In addition to augmenting the `WHERE` clauses of the `UpdateCommand` and `DeleteCommand` properties (and adding the additional parameters to the respective parameter collections), selecting the Use optimistic concurrency option adjusts two other properties:</span></span>

- <span data-ttu-id="ef5e6-169">As alterações a [ `ConflictDetection` propriedade](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) de `OverwriteChanges` (o padrão) para `CompareAllValues`</span><span class="sxs-lookup"><span data-stu-id="ef5e6-169">Changes the [`ConflictDetection` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) from `OverwriteChanges` (the default) to `CompareAllValues`</span></span>
- <span data-ttu-id="ef5e6-170">As alterações a [ `OldValuesParameterFormatString` propriedade](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) partir {0} (o padrão) ao original\_ {0} .</span><span class="sxs-lookup"><span data-stu-id="ef5e6-170">Changes the [`OldValuesParameterFormatString` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) from {0} (the default) to original\_{0} .</span></span>

<span data-ttu-id="ef5e6-171">Quando os dados de controle de Web invoca o s SqlDataSource `Update()` ou `Delete()` método, ele passa os valores originais.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-171">When the data Web control invokes the SqlDataSource s `Update()` or `Delete()` method, it passes in the original values.</span></span> <span data-ttu-id="ef5e6-172">Se o s SqlDataSource `ConflictDetection` estiver definida como `CompareAllValues`, esses valores originais são adicionados ao comando.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-172">If the SqlDataSource s `ConflictDetection` property is set to `CompareAllValues`, these original values are added to the command.</span></span> <span data-ttu-id="ef5e6-173">O `OldValuesParameterFormatString` propriedade fornece o padrão de nomenclatura usado para esses parâmetros de valor original.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-173">The `OldValuesParameterFormatString` property provides the naming pattern used for these original value parameters.</span></span> <span data-ttu-id="ef5e6-174">O Assistente Configurar fonte de dados usa original\_ {0} e os nomes de cada parâmetro original na `UpdateCommand` e `DeleteCommand` propriedades e `UpdateParameters` e `DeleteParameters` coleções adequadamente.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-174">The Configure Data Source wizard uses original\_{0} and names each original parameter in the `UpdateCommand` and `DeleteCommand` properties and `UpdateParameters` and `DeleteParameters` collections accordingly.</span></span>

> [!NOTE]
> <span data-ttu-id="ef5e6-175">Uma vez que estamos não estiver usando o controle SqlDataSource s inserindo recursos, fique à vontade remover o `InsertCommand` propriedade e seu `InsertParameters` coleção.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-175">Since we re not using the SqlDataSource control s inserting capabilities, feel free to remove the `InsertCommand` property and its `InsertParameters` collection.</span></span>


## <a name="correctly-handlingnullvalues"></a><span data-ttu-id="ef5e6-176">Tratar corretamente`NULL`valores</span><span class="sxs-lookup"><span data-stu-id="ef5e6-176">Correctly Handling`NULL`Values</span></span>

<span data-ttu-id="ef5e6-177">Infelizmente, o aumentadas `UPDATE` e `DELETE` gerado automaticamente de instruções pelo Assistente Configurar fonte de dados ao usar a simultaneidade otimista fazer *não* funcionam com os registros que contêm `NULL` valores.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-177">Unfortunately, the augmented `UPDATE` and `DELETE` statements autogenerated by the Configure Data Source wizard when using optimistic concurrency do *not* work with records that contain `NULL` values.</span></span> <span data-ttu-id="ef5e6-178">Para ver o porquê, considere o nosso s SqlDataSource `UpdateCommand`:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-178">To see why, consider our SqlDataSource s `UpdateCommand`:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample6.sql)]

<span data-ttu-id="ef5e6-179">O `UnitPrice` coluna o `Products` tabela pode ter `NULL` valores.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-179">The `UnitPrice` column in the `Products` table can have `NULL` values.</span></span> <span data-ttu-id="ef5e6-180">Se um determinado registro tem um `NULL` valor para `UnitPrice`, o `WHERE` parte da cláusula `[UnitPrice] = @original_UnitPrice` serão *sempre* forem avaliadas como False, porque `NULL = NULL` sempre retorna False.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-180">If a particular record has a `NULL` value for `UnitPrice`, the `WHERE` clause portion `[UnitPrice] = @original_UnitPrice` will *always* evaluate to False because `NULL = NULL` always returns False.</span></span> <span data-ttu-id="ef5e6-181">Portanto, os registros que contêm `NULL` valores não podem ser editados ou excluídos, como o `UPDATE` e `DELETE` instruções `WHERE` cláusulas ganharam t retornam linhas para atualizar ou excluir.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-181">Therefore, records that contain `NULL` values cannot be edited or deleted, as the `UPDATE` and `DELETE` statements `WHERE` clauses won t return any rows to update or delete.</span></span>

> [!NOTE]
> <span data-ttu-id="ef5e6-182">Esse bug foi reportado pela primeira vez para a Microsoft em junho de 2004 na [SqlDataSource gera instruções SQL incorretas](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) e supostamente está programado para ser corrigido na próxima versão do ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-182">This bug was first reported to Microsoft in June of 2004 in [SqlDataSource Generates Incorrect SQL Statements](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) and is reportedly scheduled to be fixed in the next version of ASP.NET.</span></span>


<span data-ttu-id="ef5e6-183">Para corrigir isso, temos que atualizar manualmente a `WHERE` cláusulas em ambos os `UpdateCommand` e `DeleteCommand` propriedades para **todos os** colunas que pode ter `NULL` valores.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-183">To fix this, we have to manually update the `WHERE` clauses in both the `UpdateCommand` and `DeleteCommand` properties for **all** columns that can have `NULL` values.</span></span> <span data-ttu-id="ef5e6-184">Em geral, alterar `[ColumnName] = @original_ColumnName` para:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-184">In general, change `[ColumnName] = @original_ColumnName` to:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample7.sql)]

<span data-ttu-id="ef5e6-185">Essa modificação pode ser feita diretamente por meio de marcação declarativa, por meio das opções UpdateQuery ou DeleteQuery na janela Propriedades, ou a atualização e excluir guias na especifique uma instrução SQL personalizada ou a opção de procedimento armazenado nos dados de configurar Assistente de fonte.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-185">This modification can be made directly through the declarative markup, via the UpdateQuery or DeleteQuery options from the Properties window, or through the UPDATE and DELETE tabs in the Specify a custom SQL statement or stored procedure option in the Configure Data Source wizard.</span></span> <span data-ttu-id="ef5e6-186">Novamente, essa modificação deve ser feita para *cada* coluna o `UpdateCommand` e `DeleteCommand` s `WHERE` cláusula pode conter `NULL` valores.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-186">Again, this modification must be made for *every* column in the `UpdateCommand` and `DeleteCommand` s `WHERE` clause that can contain `NULL` values.</span></span>

<span data-ttu-id="ef5e6-187">Aplicar isso ao nosso exemplo resulta no seguinte modificada `UpdateCommand` e `DeleteCommand` valores:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-187">Applying this to our example results in the following modified `UpdateCommand` and `DeleteCommand` values:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample8.sql)]

## <a name="step-2-adding-a-gridview-with-edit-and-delete-options"></a><span data-ttu-id="ef5e6-188">Etapa 2: Adicionando um GridView com editar e opções de exclusão</span><span class="sxs-lookup"><span data-stu-id="ef5e6-188">Step 2: Adding a GridView with Edit and Delete Options</span></span>

<span data-ttu-id="ef5e6-189">Com o SqlDataSource configurado para dar suporte à simultaneidade otimista, tudo o que resta é adicionar um controle da Web de dados para a página que utiliza esse controle de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-189">With the SqlDataSource configured to support optimistic concurrency, all that remains is to add a data Web control to the page that utilizes this concurrency control.</span></span> <span data-ttu-id="ef5e6-190">Para este tutorial, deixe s um GridView que fornece de edição e a funcionalidade de exclusão.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-190">For this tutorial, let s add a GridView that provides both edit and delete functionality.</span></span> <span data-ttu-id="ef5e6-191">Para fazer isso, arraste um GridView Toolbox para o Designer e defina suas `ID` para `Products`.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-191">To accomplish this, drag a GridView from the Toolbox onto the Designer and set its `ID` to `Products`.</span></span> <span data-ttu-id="ef5e6-192">Da GridView s marca inteligente, associá-lo para o `ProductsDataSourceWithOptimisticConcurrency` controle SqlDataSource adicionado na etapa 1.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-192">From the GridView s smart tag, bind it to the `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource control added in Step 1.</span></span> <span data-ttu-id="ef5e6-193">Por fim, verifique as opções de permitir edição e habilitar a exclusão da marca inteligente.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-193">Finally, check the Enable Editing and Enable Deleting options from the smart tag.</span></span>


<span data-ttu-id="ef5e6-194">[![Vincular o GridView a SqlDataSource e permitir a edição e exclusão](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-194">[![Bind the GridView to the SqlDataSource and Enable Editing and Deleting](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span></span>

<span data-ttu-id="ef5e6-195">**Figura 6**: Associar o GridView SqlDataSource e habilitar edição e exclusão ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="ef5e6-195">**Figure 6**: Bind the GridView to the SqlDataSource and Enable Editing and Deleting ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span></span>


<span data-ttu-id="ef5e6-196">Depois de adicionar o GridView, configuram sua aparência, removendo o `ProductID` BoundField, alterando a `ProductName` s BoundField `HeaderText` propriedade ao produto e atualizando o `UnitPrice` BoundField, de modo que seu `HeaderText` é de propriedade simplesmente preço.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-196">After adding the GridView, configure its appearance by removing the `ProductID` BoundField, changing the `ProductName` BoundField s `HeaderText` property to Product, and updating the `UnitPrice` BoundField so that its `HeaderText` property is simply Price.</span></span> <span data-ttu-id="ef5e6-197">O ideal é que podemos d aprimorar a interface de edição para incluir um RequiredFieldValidator para o `ProductName` valor e um CompareValidator para o `UnitPrice` valor (para assegurar que ele s um valor numérico formatado corretamente).</span><span class="sxs-lookup"><span data-stu-id="ef5e6-197">Ideally, we d enhance the editing interface to include a RequiredFieldValidator for the `ProductName` value and a CompareValidator for the `UnitPrice` value (to ensure it s a properly formatted numeric value).</span></span> <span data-ttu-id="ef5e6-198">Consulte a [Personalizando a Interface de modificação de dados](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial para uma análise mais detalhada Personalizando o s GridView interface de edição.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-198">Refer to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial for a more in-depth look at customizing the GridView s editing interface.</span></span>

> [!NOTE]
> <span data-ttu-id="ef5e6-199">O GridView, o estado de exibição s deve ser habilitado, pois os valores originais passados do GridView para o SqlDataSource são armazenados na exibição de estado.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-199">The GridView s view state must be enabled since the original values passed from the GridView to the SqlDataSource are stored in view state.</span></span>


<span data-ttu-id="ef5e6-200">Depois de fazer essas modificações para o GridView, a marcação declarativa GridView e SqlDataSource deve ser semelhante ao seguinte:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-200">After making these modifications to the GridView, the GridView and SqlDataSource declarative markup should look similar to the following:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample9.aspx)]

<span data-ttu-id="ef5e6-201">Para ver o controle de simultaneidade otimista em ação, abra duas janelas de navegador e carregar o `OptimisticConcurrency.aspx` página em ambos.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-201">To see the optimistic concurrency control in action, open two browser windows and load the `OptimisticConcurrency.aspx` page in both.</span></span> <span data-ttu-id="ef5e6-202">Clique nos botões de edição para o primeiro produto em ambos os navegadores.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-202">Click on the Edit buttons for the first product in both browsers.</span></span> <span data-ttu-id="ef5e6-203">Em um navegador, altere o nome do produto e clique em Atualizar.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-203">In one browser, change the product name and click Update.</span></span> <span data-ttu-id="ef5e6-204">O navegador fará o postback e GridView retornará para o modo de edição previamente, mostrando o novo nome do produto para o registro que acabou de editar.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-204">The browser will postback and the GridView will return to its pre-editing mode, showing the new product name for the record just edited.</span></span>

<span data-ttu-id="ef5e6-205">Na segunda janela do navegador, altere o preço (mas deixe o nome do produto como seu valor original) e clique em Atualizar.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-205">In the second browser window, change the price (but leave the product name as its original value) and click Update.</span></span> <span data-ttu-id="ef5e6-206">No postback, a grade de retorna para o modo de edição previamente, mas a alteração no preço não será registrada.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-206">On postback, the grid returns to its pre-editing mode, but the change to the price is not recorded.</span></span> <span data-ttu-id="ef5e6-207">O segundo navegador mostra o mesmo valor que a primeira é o novo nome de produto com o preço antigo.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-207">The second browser shows the same value as the first one the new product name with the old price.</span></span> <span data-ttu-id="ef5e6-208">As alterações feitas na segunda janela do navegador foram perdidas.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-208">The changes made in the second browser window were lost.</span></span> <span data-ttu-id="ef5e6-209">Além disso, as alterações foram perdidas em vez disso, no modo silencioso, pois não houve nenhuma exceção ou uma mensagem indicando que uma violação de simultaneidade ocorreu.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-209">Moreover, the changes were lost rather quietly, as there was no exception or message indicating that a concurrency violation just occurred.</span></span>


<span data-ttu-id="ef5e6-210">[![As alterações na segunda janela do navegador foram perdidas silenciosamente](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-210">[![The Changes in the Second Browser Window Were Silently Lost](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span></span>

<span data-ttu-id="ef5e6-211">**Figura 7**: As alterações em como o segundo navegador janela foram silenciosamente perdidas ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="ef5e6-211">**Figure 7**: The Changes in the Second Browser Window Were Silently Lost ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span></span>


<span data-ttu-id="ef5e6-212">O motivo por que as alterações de navegador s segunda não foram confirmadas era porque o `UPDATE` instrução s `WHERE` cláusula filtrou todos os registros e, portanto, não afetou nenhuma linha.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-212">The reason why the second browser s changes were not committed was because the `UPDATE` statement s `WHERE` clause filtered out all records and therefore did not affect any rows.</span></span> <span data-ttu-id="ef5e6-213">Permitir que o s examinar o `UPDATE` novamente a instrução:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-213">Let s look at the `UPDATE` statement again:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample10.sql)]

<span data-ttu-id="ef5e6-214">Quando a segunda janela do navegador atualiza o registro, o nome do produto original especificado no `WHERE` cláusula t correspondente com o nome de produto existente (uma vez que ele foi alterado pelo navegador primeiro).</span><span class="sxs-lookup"><span data-stu-id="ef5e6-214">When the second browser window updates the record, the original product name specified in the `WHERE` clause doesn t match up with the existing product name (since it was changed by the first browser).</span></span> <span data-ttu-id="ef5e6-215">Portanto, a instrução `[ProductName] = @original_ProductName` retorna False e o `UPDATE` não afeta todos os registros.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-215">Therefore, the statement `[ProductName] = @original_ProductName` returns False, and the `UPDATE` does not affect any records.</span></span>

> [!NOTE]
> <span data-ttu-id="ef5e6-216">Exclua funciona da mesma maneira.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-216">Delete works in the same manner.</span></span> <span data-ttu-id="ef5e6-217">Com duas janelas de navegador abertas, começar a edição de um determinado produto com um e, em seguida, salvando suas alterações.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-217">With two browser windows open, start by editing a given product with one, and then saving its changes.</span></span> <span data-ttu-id="ef5e6-218">Depois de salvar as alterações em um navegador, clique no botão de exclusão para o mesmo produto na outra.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-218">After saving the changes in the one browser, click the Delete button for the same product in the other.</span></span> <span data-ttu-id="ef5e6-219">Uma vez que o original don valores t coincidir as `DELETE` instrução s `WHERE` cláusula, a exclusão falhará silenciosamente.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-219">Since the original values don t match up in the `DELETE` statement s `WHERE` clause, the delete silently fails.</span></span>


<span data-ttu-id="ef5e6-220">Da perspectiva do usuário final s na segunda janela do navegador, depois de clicar no botão atualizar a grade retorna ao modo de edição previamente, mas suas alterações foram perdidas.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-220">From the end user s perspective in the second browser window, after clicking the Update button the grid returns to the pre-editing mode, but their changes were lost.</span></span> <span data-ttu-id="ef5e6-221">No entanto, há s sem comentários visuais que fique t de suas alterações.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-221">However, there s no visual feedback that their changes didn t stick.</span></span> <span data-ttu-id="ef5e6-222">O ideal é que, se um alterações de usuário s são perdidas para uma violação de simultaneidade, podemos d notificá-lo e, talvez, mantenha a grade no modo de edição.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-222">Ideally, if a user s changes are lost to a concurrency violation, we d notify them and, perhaps, keep the grid in edit mode.</span></span> <span data-ttu-id="ef5e6-223">Deixe o s examinar como fazer isso.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-223">Let s look at how to accomplish this.</span></span>

## <a name="step-3-determining-when-a-concurrency-violation-has-occurred"></a><span data-ttu-id="ef5e6-224">Etapa 3: Determinando quando ocorreu uma violação de simultaneidade</span><span class="sxs-lookup"><span data-stu-id="ef5e6-224">Step 3: Determining When a Concurrency Violation Has Occurred</span></span>

<span data-ttu-id="ef5e6-225">Uma vez que uma violação de simultaneidade rejeita as alterações feitas por um, seria bom alertar o usuário quando ocorreu uma violação de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-225">Since a concurrency violation rejects the changes one has made, it would be nice to alert the user when a concurrency violation has occurred.</span></span> <span data-ttu-id="ef5e6-226">Para alertar o usuário, let s adicionar um controle de Web de rótulo na parte superior da página denominada `ConcurrencyViolationMessage` cujo `Text` propriedade exibirá a seguinte mensagem: Você tentou atualizar ou excluir um registro que foi atualizado simultaneamente por outro usuário.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-226">To alert the user, let s add a Label Web control to the top of the page named `ConcurrencyViolationMessage` whose `Text` property displays the following message: You have attempted to update or delete a record that was simultaneously updated by another user.</span></span> <span data-ttu-id="ef5e6-227">Examine as alterações de outros usuários e refaça sua atualização ou excluir.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-227">Please review the other user's changes and then redo your update or delete.</span></span> <span data-ttu-id="ef5e6-228">Defina o controle de rótulo s `CssClass` propriedade para aviso, que é uma classe CSS definida no arquivo `Styles.css` que exibe texto em uma fonte vermelha, itálico, negrito e grande.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-228">Set the Label control s `CssClass` property to Warning, which is a CSS class defined in `Styles.css` that displays text in a red, italic, bold, and large font.</span></span> <span data-ttu-id="ef5e6-229">Por fim, defina o rótulo s `Visible` e `EnableViewState` propriedades a serem `false`.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-229">Finally, set the Label s `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="ef5e6-230">Isso ocultará o rótulo, exceto apenas essas postagens onde definimos seu `Visible` propriedade para `true`.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-230">This will hide the Label except for only those postbacks where we explicitly set its `Visible` property to `true`.</span></span>


<span data-ttu-id="ef5e6-231">[![Adicionar um controle de rótulo para a página para exibir o aviso](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-231">[![Add a Label Control to the Page to Display the Warning](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span></span>

<span data-ttu-id="ef5e6-232">**Figura 8**: Adicionar um controle de rótulo para a página para exibir o aviso ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="ef5e6-232">**Figure 8**: Add a Label Control to the Page to Display the Warning ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span></span>


<span data-ttu-id="ef5e6-233">Ao executar uma atualização ou exclusão, o s GridView `RowUpdated` e `RowDeleted` manipuladores de eventos é acionado depois que seu controle de fonte de dados tiver efetuado solicitada update ou delete.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-233">When performing an update or delete, the GridView s `RowUpdated` and `RowDeleted` event handlers fire after its data source control has performed the requested update or delete.</span></span> <span data-ttu-id="ef5e6-234">Podemos determinar quantas linhas foram afetadas pela operação desses manipuladores de eventos.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-234">We can determine how many rows were affected by the operation from these event handlers.</span></span> <span data-ttu-id="ef5e6-235">Se nenhuma linha foi afetada, queremos exibir o `ConcurrencyViolationMessage` rótulo.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-235">If zero rows were affected, we want to display the `ConcurrencyViolationMessage` Label.</span></span>

<span data-ttu-id="ef5e6-236">Criar um manipulador de eventos para ambos os `RowUpdated` e `RowDeleted` eventos e adicione o seguinte código:</span><span class="sxs-lookup"><span data-stu-id="ef5e6-236">Create an event handler for both the `RowUpdated` and `RowDeleted` events and add the following code:</span></span>


[!code-csharp[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample11.cs)]

<span data-ttu-id="ef5e6-237">Em ambos os manipuladores de eventos verificamos a `e.AffectedRows` propriedade e, se ele for igual a 0, defina a `ConcurrencyViolationMessage` rótulo s `Visible` propriedade `true`.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-237">In both event handlers we check the `e.AffectedRows` property and, if it equals 0, set the `ConcurrencyViolationMessage` Label s `Visible` property to `true`.</span></span> <span data-ttu-id="ef5e6-238">No `RowUpdated` manipulador de eventos, podemos também instruir o GridView permanecer no modo de edição, definindo o `KeepInEditMode` propriedade como true.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-238">In the `RowUpdated` event handler, we also instruct the GridView to stay in edit mode by setting the `KeepInEditMode` property to true.</span></span> <span data-ttu-id="ef5e6-239">Dessa forma, é preciso associar novamente os dados à grade para que os outros dados de usuário s seja carregados para a interface de edição.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-239">In doing so, we need to rebind the data to the grid so that the other user s data is loaded into the editing interface.</span></span> <span data-ttu-id="ef5e6-240">Isso é feito chamando o GridView s `DataBind()` método.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-240">This is accomplished by calling the GridView s `DataBind()` method.</span></span>

<span data-ttu-id="ef5e6-241">Como mostra a Figura 9, com esses dois manipuladores de evento, será exibida uma mensagem muito notável sempre que ocorre uma violação de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-241">As Figure 9 shows, with these two event handlers, a very noticeable message is displayed whenever a concurrency violation occurs.</span></span>


<span data-ttu-id="ef5e6-242">[![Será exibida uma mensagem em caso de uma violação de simultaneidade](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-242">[![A Message is Displayed in the Face of a Concurrency Violation](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span></span>

<span data-ttu-id="ef5e6-243">**Figura 9**: Será exibida uma mensagem em caso de uma violação de simultaneidade ([clique para exibir a imagem em tamanho normal](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="ef5e6-243">**Figure 9**: A Message is Displayed in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span></span>


## <a name="summary"></a><span data-ttu-id="ef5e6-244">Resumo</span><span class="sxs-lookup"><span data-stu-id="ef5e6-244">Summary</span></span>

<span data-ttu-id="ef5e6-245">Ao criar um aplicativo da web onde simultânea de vários usuários podem estar editando os mesmos dados, é importante considerar as opções de controle de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-245">When creating a web application where multiple, concurrent users may be editing the same data, it is important to consider concurrency control options.</span></span> <span data-ttu-id="ef5e6-246">Por padrão, os dados de que controles da Web do ASP.NET e controles de fonte de dados não empregar qualquer controle de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-246">By default, the ASP.NET data Web controls and data source controls do not employ any concurrency control.</span></span> <span data-ttu-id="ef5e6-247">Como vimos neste tutorial, a implementação de controle de simultaneidade otimista com o SqlDataSource é relativamente fácil e rápido.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-247">As we saw in this tutorial, implementing optimistic concurrency control with the SqlDataSource is relatively quick and easy.</span></span> <span data-ttu-id="ef5e6-248">O SqlDataSource manipula a maioria do trabalho externo para sua adição aumentada `WHERE` cláusulas para gerada automaticamente `UPDATE` e `DELETE` , mas há instruções são algumas sutilezas na manipulação de `NULL` valor colunas, conforme discutido no Tratar corretamente `NULL` valores da seção.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-248">The SqlDataSource handles most of the legwork for your adding augmented `WHERE` clauses to the autogenerated `UPDATE` and `DELETE` statements but there are a few subtleties in handling `NULL` value columns, as discussed in the Correctly Handling `NULL` Values section.</span></span>

<span data-ttu-id="ef5e6-249">Esse tutorial conclui nossa análise do SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-249">This tutorial concludes our examination of the SqlDataSource.</span></span> <span data-ttu-id="ef5e6-250">Nossos tutoriais restantes retornará a trabalhar com dados usando o ObjectDataSource e arquitetura em camadas.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-250">Our remaining tutorials will return to working with data using the ObjectDataSource and tiered architecture.</span></span>

<span data-ttu-id="ef5e6-251">Boa programação!</span><span class="sxs-lookup"><span data-stu-id="ef5e6-251">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="ef5e6-252">Sobre o autor</span><span class="sxs-lookup"><span data-stu-id="ef5e6-252">About the Author</span></span>

<span data-ttu-id="ef5e6-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor de sete livros sobre ASP/ASP.NET e fundador da [4GuysFromRolla.com](http://www.4guysfromrolla.com), tem trabalhado com tecnologias Microsoft Web desde 1998.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="ef5e6-254">Scott funciona como um consultor independente, instrutor e escritor.</span><span class="sxs-lookup"><span data-stu-id="ef5e6-254">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="ef5e6-255">Seu livro mais recente é [ *Sams Teach por conta própria ASP.NET 2.0 em 24 horas*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="ef5e6-255">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="ef5e6-256">Ele pode ser contatado pelo [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-256">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="ef5e6-257">ou por meio de seu blog, que pode ser encontrado em [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="ef5e6-257">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="ef5e6-258">[Anterior](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
> [Próximo](querying-data-with-the-sqldatasource-control-vb.md)</span><span class="sxs-lookup"><span data-stu-id="ef5e6-258">[Previous](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
[Next](querying-data-with-the-sqldatasource-control-vb.md)</span></span>
